<div *ngIf="viewContent">
  <div class="flex items-start justify-between bg-primary sidepanel-header">
    <div class="text-on-primary" style="padding-top: 6px">Bulk Edit Milestones</div>
    <div style="padding-top: 2px">
      <a (click)="projecthubservice.toggleDrawerOpen('', '',[],'',false)" href="javascript:void(0)" title="Close">
        <mat-icon class="text-on-primary" svgIcon="heroicons_outline:x"></mat-icon>
      </a>
    </div>
  </div>

  <div class="mt-6 flex justify-end items-left w-full" style="margin-right: 1.5rem;">
    <button class="w-25" mat-flat-button [color]="'primary'" type="button" (click)="addMilestoneRecord()">
      Add New
    </button>
    &nbsp;
  </div>

  <div class="mt-3 p-3 h-[80vh] overflow-y-scroll">
    <ngx-datatable class="pr-6 pl-2 material font-medium text-sm text-secondary whitespace-nowrap"
      [rows]="scheduleData.scheduleData" #scheduleTable columnMode="flex" [headerHeight]="'auto'" [rowHeight]="'auto'"
      [scrollbarV]="false">
      <ngx-datatable-column name="Status" prop="indicator" [resizeable]="false" [sortable]="false" [flexGrow]="0.5">
        <ng-template let-row="row" let-value="value" ngx-datatable-cell-template>
          <mat-icon svgIcon="{{(indicator.getIndicators(value, 'circle')).icontype}}"
            class="{{(indicator.getIndicators(value, 'circle')).iconcolor}}">
          </mat-icon>
          &nbsp;
          &nbsp;
          <mat-icon [matTooltip]="getlinkname(row.scheduleUniqueId)" *ngIf="islink(row.scheduleUniqueId)"
            svgIcon="heroicons_outline:link"></mat-icon>
        </ng-template>
      </ngx-datatable-column>


      <ngx-datatable-column name="Milestone" prop="milestone" [resizeable]="false" [sortable]="false" [flexGrow]="1">
        <ng-template let-row="row" let-rowIndex="rowIndex" let-value="value" ngx-datatable-cell-template>
          <a *ngIf="!milestoneTableEditStack.includes(rowIndex)" (click)="milestoneTableEditRow(rowIndex)">
            <p *ngIf="value == ''">&nbsp;</p>{{value}}
          </a>
          <form [formGroup]="milestoneForm.controls[rowIndex]" *ngIf="milestoneTableEditStack.includes(rowIndex)">
            <spot-input formControlName="milestone" name="milestone" [showLabel]="false"
              [placeholder]="'Milestone Name'">
            </spot-input>
          </form>
        </ng-template>
      </ngx-datatable-column>
      <ngx-datatable-column name="Planned Finish" prop="plannedFinish" [resizeable]="false"  [sortable]="false"[flexGrow]="1">
        <ng-template let-row="row" let-rowIndex="rowIndex" let-value="value" ngx-datatable-cell-template>
          <a *ngIf="!milestoneTableEditStack.includes(rowIndex)" (click)="milestoneTableEditRow(rowIndex)">
            <p *ngIf="value == ''">&nbsp;</p>{{value | date:'dd-MMM-yyyy'}}
          </a>
          <form [formGroup]="milestoneForm.controls[rowIndex]" *ngIf="milestoneTableEditStack.includes(rowIndex)">
            <spot-input-date formControlName="plannedFinish" name="plannedFinish" [showLabel]="false"
              [placeholder]="'Planned Finish Date'"></spot-input-date>
          </form>
        </ng-template>
      </ngx-datatable-column>
      <ngx-datatable-column name="Baseline Finish" prop="baselineFinish" [resizeable]="false" [sortable]="false" [flexGrow]="1">
        <ng-template let-row="row" let-rowIndex="rowIndex" let-value="value" ngx-datatable-cell-template>
          <a *ngIf="!milestoneTableEditStack.includes(rowIndex)" (click)="milestoneTableEditRow(rowIndex)">
            <p *ngIf="value == ''">&nbsp;</p>{{value | date:'dd-MMM-yyyy'}}
          </a>
          <form [formGroup]="milestoneForm.controls[rowIndex]" *ngIf="milestoneTableEditStack.includes(rowIndex)">
            <spot-input-date formControlName="baselineFinish" name="baselineFinish" [showLabel]="false"
              [placeholder]="'Baseline Finish Date'"></spot-input-date>
          </form>
        </ng-template>
      </ngx-datatable-column>
      <ngx-datatable-column name="Variance" prop="variance" [resizeable]="false" [flexGrow]="1">
        <ng-template ngx-datatable-cell-template let-value="value" let-row="row">

          {{calculateVariance(row)}}

        </ng-template>
      </ngx-datatable-column>
      <ngx-datatable-column name="Responsible Person" prop="responsiblePersonName" [resizeable]="false" [sortable]="false" [flexGrow]="1">
        <ng-template let-row="row" let-rowIndex="rowIndex" let-value="value" ngx-datatable-cell-template>
          <a *ngIf="!milestoneTableEditStack.includes(rowIndex)" (click)="milestoneTableEditRow(rowIndex)">
            <p *ngIf="value == ''">&nbsp;</p>{{value}}
          </a>
          <form [formGroup]="milestoneForm.controls[rowIndex]" *ngIf="milestoneTableEditStack.includes(rowIndex)">
            <spot-singleselect-user-autocomplete formControlName="responsiblePersonName" name="responsiblePersonName"
              [placeholder]="'Type Last, First Name or e-Mail Address and hit enter'" [showLabel]="false">
            </spot-singleselect-user-autocomplete>
          </form>
        </ng-template>
      </ngx-datatable-column>
      <ngx-datatable-column name="Function Owner" prop="functionGroupId" [resizeable]="false" [sortable]="false" [flexGrow]="1">
        <ng-template let-row="row" let-rowIndex="rowIndex" let-value="value" ngx-datatable-cell-template>
          <a *ngIf="!milestoneTableEditStack.includes(rowIndex)" (click)="milestoneTableEditRow(rowIndex)">
            <p *ngIf="value == ''">&nbsp;</p>{{getLookupName(value)}}
          </a>
          <form [formGroup]="milestoneForm.controls[rowIndex]" *ngIf="milestoneTableEditStack.includes(rowIndex)">
            <spot-singleselect-autocomplete formControlName="function" [showLabel]="false"
              [placeholder]="'Function Owner'" [valuePointer]="'lookUpName'" [dropDownArray]="getFunctionOwner()">
            </spot-singleselect-autocomplete>
          </form>
        </ng-template>
      </ngx-datatable-column>
      <ngx-datatable-column name="Completion Date" prop="completionDate" [resizeable]="false" [sortable]="false" [flexGrow]="1">
        <ng-template let-row="row" let-rowIndex="rowIndex" let-value="value" ngx-datatable-cell-template>
          <a *ngIf="!milestoneTableEditStack.includes(rowIndex)" (click)="milestoneTableEditRow(rowIndex)">
            <p *ngIf="value == ''">&nbsp;</p>{{value | date:'dd-MMM-yyyy'}}
          </a>
          <form [formGroup]="milestoneForm.controls[rowIndex]" *ngIf="milestoneTableEditStack.includes(rowIndex)">
            <spot-input-date formControlName="completionDate" name="completionDate" [showLabel]="false"
              [placeholder]="'Completion Date'"></spot-input-date>
          </form>
        </ng-template>
      </ngx-datatable-column>
      <ngx-datatable-column name="Comments" prop="comments" [resizeable]="false" [sortable]="false" [flexGrow]="1">
        <ng-template let-row="row" let-rowIndex="rowIndex" let-value="value" ngx-datatable-cell-template>
          <a *ngIf="!milestoneTableEditStack.includes(rowIndex)" (click)="milestoneTableEditRow(rowIndex)">
            <p *ngIf="value == ''">&nbsp;</p>{{value}}
          </a>
          <form [formGroup]="milestoneForm.controls[rowIndex]" *ngIf="milestoneTableEditStack.includes(rowIndex)">
            <spot-input formControlName="comments" name="comments" [showLabel]="false" [placeholder]="'Comments'">
            </spot-input>
          </form>
        </ng-template>
      </ngx-datatable-column>
      <ngx-datatable-column name="Include in Project Dashboard" prop="includeInReport" [sortable]="false" [resizeable]="false"
        [flexGrow]="1">
        <ng-template let-row="row" let-rowIndex="rowIndex" let-value="value" ngx-datatable-cell-template>
          <a *ngIf="!milestoneTableEditStack.includes(rowIndex)" (click)="milestoneTableEditRow(rowIndex)">
            <p *ngIf="!value">&nbsp;</p>
            <mat-icon svgIcon="heroicons_outline:check-circle" *ngIf="value == true"></mat-icon>
          </a>
          <form [formGroup]="milestoneForm.controls[rowIndex]" *ngIf="milestoneTableEditStack.includes(rowIndex)" class="p-2 overflow-hidden">
            <div class="flex items-center justify-between">
              <mat-slide-toggle name="includeInReport" [showLabel]="false" formControlName="includeInReport">
              </mat-slide-toggle>
            </div>
          </form>
        </ng-template>
      </ngx-datatable-column>
      <ngx-datatable-column [flexGrow]="1" [resizeable]="false" [sortable]="false" [draggable]="false">
        <ng-template let-row="row" let-rowIndex="rowIndex" ngx-datatable-cell-template>

          <div class="flex items-center justify-start gap-6">
            <a href="javascript:void(0)" title="Delete"
              (click)="deleteSchedule(row.scheduleUniqueId, row, rowIndex)">
              <mat-icon svgIcon="heroicons_outline:trash"></mat-icon>
            </a>
          </div>
        </ng-template>
      </ngx-datatable-column>
    </ngx-datatable>
  </div>
  <div class="mt-6 flex justify-between items-center w-full">

    <button class="w-25" mat-flat-button [color]="'primary'"
      (click)="this.projecthubservice.toggleDrawerOpen('', '',[],'')">
      Cancel
    </button>

    <button class="w-25" mat-flat-button [color]="'primary'" type="button" (click)="submitschedule()">
      Submit
    </button>

  </div>
</div>