function ProjectBudgetCtrl(n,t,i,r,u,f){function st(){var n=$("#dialogFxRate");n.kendoWindow({content:"CurrencyFxRate.html?v="+buildNo,modal:!0});$.when(f.getCurrencyFxRate()).then(function(){n.data("kendoWindow").open()})}function ht(){var n,t,u;try{SeletedProjectId=getParameterByName(window.location.search,"ProblemID");e.definitiveCRDateError=!1;e.fundingNeedDateError=!1;e.capexOpexSubmit=!1;e.isCapexRequiredEditable=!1;e.isBudgetIdEditable=!1;e.isBudgetOwnerEditable=!1;e.IsOpen=!0;e.options={format:"n0",decimals:0,min:0,restrictDecimals:!0};v=!1;n={ProjectUID:SeletedProjectId,UserID:currentUserId};t=fundingStatus+","+capitalDeviationCodesMonthly+","+CapitalDeviationCodesYTD+","+localcurrency+","+where+","+why+","+predefinedInvestment;$.when(f.postDataWCFAsync("getLookupData",t),f.postDataWCFAsync("getProjectBudgetByID",SeletedProjectId),f.postDataWCFAsync("getProjectBudgetForecastDataY1",SeletedProjectId),f.postDataWCFAsync("getProjectBudgetForecastData",SeletedProjectId),f.getDataWCFAsync("getUserPermissionByProjectUserId/"+currentUserId+"/"+SeletedProjectId),f.postDataWCFAsync("getUserPermissionById",currentUserId),f.postDataWCFAsync("getBudgetIO",SeletedProjectId),f.postDataWCFAsync("getPortfolioOwnerWithCurrency",n),f.postDataWCFAsync("getYearLabel")).then(function(n,t,r,u,o,l,p,d,g){var it,rt,ut,ft,et,ot,st,ht,yt,tt,bt;try{it=JSON.parse(n.getLookupDataResult);rt=JSON.parse(o.getUserPermissionByProjectUserIdResult);h=JSON.parse(g.getYearLabelResult);e.isEditable=rt[0].canEdit==!0?!0:!1;c=JSON.parse(l.getUserPermissionByIdResult);c!=null&&(a=!1,e.IsOpen=!1,b=!1,angular.forEach(c,function(n){n.Permission==updateBudgetPerm?a=!0:n.Permission==UpdateBudgetOwner?(b=!0,e.isBudgetOwnerEditable=!0):n.Permission==DeleteBudgetIO&&(e.isDeleteBudgetIO=!0)}));e.dsBudgetOwner=JSON.parse(d);e.dsCapExRequired=[{LookUpMemberID:"1",LookUpMemberName:"Yes"},{LookUpMemberID:"0",LookUpMemberName:"No"}];e.dsBudgetData=JSON.parse(t.getProjectBudgetByIDResult);e.dsForecastDataY1=JSON.parse(r.getProjectBudgetForecastDataY1Result);e.dsForecastData=JSON.parse(u.getProjectBudgetForecastDataResult);e.capexForecast=JSON.parse(u.getProjectBudgetForecastDataResult).filter(function(n){return n.BudgetDataTypeID==capexID}).reverse();e.opexForecast=JSON.parse(u.getProjectBudgetForecastDataResult).filter(function(n){return n.BudgetDataTypeID==opexID}).reverse();e.capexForecastY1=JSON.parse(r.getProjectBudgetForecastDataY1Result).filter(function(n){return n.BudgetDataTypeID==capexID});e.opexForecastY1=JSON.parse(r.getProjectBudgetForecastDataY1Result).filter(function(n){return n.BudgetDataTypeID==opexID});k=JSON.parse(p.getBudgetIOResult);e.SelectedBudget=e.dsBudgetData[0];y=e.SelectedBudget.PreliminaryCount>0?1:0;y==1?(e.capexForecastCommittedSpend=e.capexForecast.filter(function(n){return n.ActiveID==preliminary})[0].CommittedSpend,e.opexForecastCommittedSpend=e.opexForecast.filter(function(n){return n.ActiveID==preliminary})[0].CommittedSpend):(e.capexForecastCommittedSpend=e.capexForecast.filter(function(n){return n.ActiveID==currentForecastId})[0].CommittedSpend,e.opexForecastCommittedSpend=e.opexForecast.filter(function(n){return n.ActiveID==currentForecastId})[0].CommittedSpend);e.capexRequired=e.SelectedBudget.CapExRequired==!0?!0:!1;e.opexRequired=e.SelectedBudget.OpExRequired==!0?!0:!1;(e.capexRequired||e.opexRequired)&&(e.capexOpexSubmit=!0);e.capexRequired==!0?(ut=c.filter(function(n){return n.Permission==EditCapexRequiredPerm}),e.isCapexRequiredEditable=ut.length>0&&e.isEditable==!0?!0:!1):e.isEditable==!0&&(e.isCapexRequiredEditable=!0);(e.SelectedBudget.CapitalBudgetID==""||e.SelectedBudget.CapitalBudgetID==null)&&e.isEditable==!0?(v=!0,e.isBudgetIdEditable=!0):(ft=c.filter(function(n){return n.Permission==EditBudgetIDPerm}),e.isBudgetIdEditable=ft.length>0&&e.isEditable==!0?!0:!1);e.dsFundingStatus=it.filter(function(n){return n.LookUpName===fundingStatus});e.dsCapitalDeviationMonthly=it.filter(function(n){return n.LookUpName===capitalDeviationCodesMonthly});e.dsCapitalDeviationYearly=it.filter(function(n){return n.LookUpName===CapitalDeviationCodesYTD});e.dsLocalCurrency=it.filter(function(n){return n.LookUpName===localcurrency});e.dsBudgetWhere=it.filter(function(n){return n.LookUpName===where});e.dsBudgetWhy=it.filter(function(n){return n.LookUpName===why});e.dsPreDefinedInvestment=it.filter(function(n){return n.LookUpName===predefinedInvestment});e.SelectedBudget.CapExRequired!=null&&(et=e.dsCapExRequired.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.CapExRequired}),e.SelectedBudget.CapExRequired=et[0]);e.SelectedBudget.OpExRequired!=null&&(ot=e.dsCapExRequired.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.OpExRequired}),e.SelectedBudget.OpExRequired=ot[0]);e.dsBudgetData[0]!=null&&(e.LocalCurrencyAbb!=null&&(e.LocalCurrencyAbb="("+e.SelectedBudget.LocalCurrencyAbbreviation+")",e.LocalCurrencyPlaceholderAbb=e.SelectedBudget.LocalCurrencyAbbreviation),e.SelectedBudget.LastSubmitted=e.SelectedBudget.LastSubmitted!=null?kendo.toString(kendo.parseDate(e.SelectedBudget.LastSubmitted),"dd-MMM-yy  hh:mm:ss"):"",e.SelectedBudget.PreliminaryLastSubmitted=e.SelectedBudget.PreliminaryLastSubmitted!=null?kendo.toString(kendo.parseDate(e.SelectedBudget.PreliminaryLastSubmitted),"dd-MMM-yy  hh:mm:ss"):"",e.SelectedBudget.FundingStatusID!=null&&(tt=e.dsFundingStatus.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.FundingStatusID}),e.SelectedBudget.FundingStatusID=tt[0]),e.SelectedBudget.MTDPDeviationCodeID!=null&&(tt=e.dsCapitalDeviationMonthly.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.MTDPDeviationCodeID}),e.SelectedBudget.MTDPDeviationCodeID=tt[0]),e.SelectedBudget.AFPDeviationCodeID!=null&&(tt=e.dsCapitalDeviationYearly.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.AFPDeviationCodeID}),e.SelectedBudget.AFPDeviationCodeID=tt[0]),e.SelectedBudget.WhereID!=null&&(st=e.dsBudgetWhere.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.WhereID}),e.SelectedBudget.WhereID=st[0]),e.SelectedBudget.WhyID!=null&&(ht=e.dsBudgetWhy.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.WhyID}),e.SelectedBudget.WhyID=ht[0]),e.SelectedBudget.PredefinedInvestmentID!=null&&(yt=e.dsPreDefinedInvestment.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.PredefinedInvestmentID}),e.SelectedBudget.PredefinedInvestmentID=yt[0]),e.SelectedBudget.LocalCurrencyID!=null&&(tt=e.dsLocalCurrency.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.LocalCurrencyID}),e.SelectedBudget.LocalCurrencyID=tt[0]),e.SelectedBudget.BudgetOwner!=null&&(tt=e.dsBudgetOwner.filter(function(n){return n.PortfolioOwnerID==e.SelectedBudget.BudgetOwner}),e.SelectedBudget.BudgetOwner=tt[0]),((e.SelectedBudget.BudgetOwner==null||e.SelectedBudget.BudgetOwner=="")&&e.isEditable==!0||e.SelectedBudget.BudgetOwner!=null&&e.SelectedBudget.BudgetOwner!=""&&e.SelectedBudget.GMSBudgetOwnerEditable==!0&&e.isEditable==!0&&e.SelectedBudget.CapExRequired.LookUpMemberID=="0")&&(e.isBudgetOwnerEditable=!0));e.isEditable==!1?e.IsOpen=!1:e.SelectedBudget.Isopen=="1"&&(e.IsOpen=!0);a&&(e.IsOpen=!0);nt?(bindChangeComboBox("funding"),bindChangeComboBox("currency"),bindChangeComboBox("preDefinedInvest"),bindChangeComboBox("Where"),bindChangeComboBox("Why"),ct(),lt(),at(),vt(),w("definitiveCRApprovalDate"),w("fundingNeedDate"),w("crApprovalDate"),w("APISDate"),wt(),nt=!1):($("#gridBudgetOpexY1").data("kendoGrid").dataSource.read(),$("#gridBudgetOpex").data("kendoGrid").dataSource.read(),$("#gridBudgetCapexY1").data("kendoGrid").dataSource.read(),$("#gridBudgetCapex").data("kendoGrid").dataSource.read(),$("#gridbudgetIO").data("kendoGrid").dataSource.read());i.$digest();hideLoading()}catch(pt){bt={method:"prepareDataForBudget",exceptionMessage:"message:"+pt.message+" stack:"+pt.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",bt)).then(function(){alert(errormessage)});hideLoading()}})}catch(r){u={method:"prepareDataForBudget",exceptionMessage:"message:"+r.message+" stack:"+r.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",u)).then(function(){alert(errormessage)});hideLoading()}}function tt(){var t,i,r,u,o,n,c;try{e.capexOpexSubmit=!1;e.capexRequired=e.SelectedBudget.CapExRequired==!0?!0:!1;e.opexRequired=e.SelectedBudget.OpExRequired==!0?!0:!1;(e.capexRequired||e.opexRequired)&&(e.capexOpexSubmit=!0);e.SelectedBudget.CapExRequired!=null&&(t=e.dsCapExRequired.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.CapExRequired}),e.SelectedBudget.CapExRequired=t[0]);e.SelectedBudget.OpExRequired!=null&&(i=e.dsCapExRequired.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.OpExRequired}),e.SelectedBudget.OpExRequired=i[0]);e.SelectedBudget!=null&&(e.SelectedBudget.LastSubmitted!=null&&(e.SelectedBudget.LastSubmitted=kendo.toString(kendo.parseDate(e.SelectedBudget.LastSubmitted),"dd-MMM-yy  hh:mm:ss")),e.SelectedBudget.PreliminaryLastSubmitted!=null&&(e.SelectedBudget.PreliminaryLastSubmitted=kendo.toString(kendo.parseDate(e.SelectedBudget.PreliminaryLastSubmitted),"dd-MMM-yy  hh:mm:ss")),e.SelectedBudget.FundingStatusID!=null&&(n=e.dsFundingStatus.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.FundingStatusID}),e.SelectedBudget.FundingStatusID=n[0]),e.SelectedBudget.MTDPDeviationCodeID!=null&&(n=e.dsCapitalDeviationMonthly.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.MTDPDeviationCodeID}),e.SelectedBudget.MTDPDeviationCodeID=n[0]),e.SelectedBudget.AFPDeviationCodeID!=null&&(n=e.dsCapitalDeviationYearly.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.AFPDeviationCodeID}),e.SelectedBudget.AFPDeviationCodeID=n[0]),e.SelectedBudget.WhereID!=null&&(r=e.dsBudgetWhere.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.WhereID}),e.SelectedBudget.WhereID=r[0]),e.SelectedBudget.WhyID!=null&&(u=e.dsBudgetWhy.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.WhyID}),e.SelectedBudget.WhyID=u[0]),e.SelectedBudget.PredefinedInvestmentID!=null&&(o=e.dsPreDefinedInvestment.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.PredefinedInvestmentID}),e.SelectedBudget.PredefinedInvestmentID=o[0]),e.SelectedBudget.LocalCurrencyID!=null&&(n=e.dsLocalCurrency.filter(function(n){return n.LookUpMemberID==e.SelectedBudget.LocalCurrencyID}),e.SelectedBudget.LocalCurrencyID=n[0]),e.SelectedBudget.BudgetOwner!=null&&(n=e.dsBudgetOwner.filter(function(n){return n.PortfolioOwnerID==e.SelectedBudget.BudgetOwner}),e.SelectedBudget.BudgetOwner=n[0]));e.isBudgetOwnerEditable=(e.SelectedBudget.BudgetOwner==null||e.SelectedBudget.BudgetOwner=="")&&e.isEditable==!0||e.SelectedBudget.BudgetOwner!=null&&e.SelectedBudget.BudgetOwner!=""&&e.SelectedBudget.GMSBudgetOwnerEditable==!0&&e.isEditable==!0&&e.SelectedBudget.CapExRequired.LookUpMemberID=="0"?!0:!1;a&&(e.IsOpen=!0);b&&(e.isBudgetOwnerEditable=!0)}catch(h){c={method:"GetProjectBudgetData",exceptionMessage:"message:"+h.message+" stack:"+h.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",c)).then(function(){alert(errormessage)});hideLoading()}}function ct(){var i=0,n=null,r=new kendo.data.DataSource({transport:{read:function(n){n.success(e.capexForecast)}},sort:[{field:"ActiveOrder",dir:"asc"}],schema:{model:{id:"BudgetDataID",fields:{BudgetDataID:{hidden:!0},Active:{editable:!1},LocalCurrencyAbbreviation:{editable:!1},Historical:{type:"number",editable:!1},Apr:{type:"number"},May:{type:"number"},Jun:{type:"number"},Jul:{type:"number"},Aug:{type:"number"},Sep:{type:"number"},Oct:{type:"number"},Nov:{type:"number"},Dec:{type:"number"},Jan:{type:"number"},Feb:{type:"number"},Mar:{type:"number"},AnnualTotal:{type:"number",editable:!1},Y1:{type:"number",editable:!1},Y2:{type:"number"},Y3:{type:"number"},Y4:{type:"number"},Y5:{type:"number"},CumulativeTotal:{type:"number",editable:!1}}}}}),u=[{field:"BudgetDataID",hidden:!0},{field:"Active",title:"Reference",headerAttributes:{"class":"wrap-header"},width:"5%",editable:!1},{field:"LocalCurrencyAbbreviation",title:"Currency",headerAttributes:{"class":"wrap-header"},width:"4%",editable:!1},{field:"Historical",headerAttributes:{"class":"wrap-header"},width:"5%",editable:!1,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Apr",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"May",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Jun",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Jul",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Aug",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Sep",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Oct",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Nov",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Dec",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Jan",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Feb",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Mar",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"AnnualTotal",title:h[0].TblLabel,editable:!1,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Y1",title:h[1].TblLabel,editable:!1,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Y2",title:h[2].TblLabel,editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Y3",title:h[3].TblLabel,editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Y4",title:h[4].TblLabel,editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Y5",title:h[5].TblLabel,editor:o,format:"{0:#,#}",headerAttributes:{"class":"wrap-header"},attributes:{"class":"txt-float-R"}},{field:"CumulativeTotal",title:"Total CAPEX",headerAttributes:{"class":"wrap-header"},editable:!1,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},],t;$("#gridBudgetCapex").kendoGrid({columns:u,dataSource:r,allowCopy:!0,editable:!0,navigatable:!0,edit:function(r){var u,h;try{r.model.Active=="Previous"||r.model.Active=="Plan"?this.closeCell():(e.dsBudgetData[0].PreliminaryCount!=0&&r.model.Active=="Current"&&this.closeCell(),e.IsOpen?(u=t.columns[r.container.index()].field,p.indexOf(u)!=-1&&p.indexOf(u)<r.model.ActualMonths?this.closeCell():($("[name='"+u+"']",r.container).blur(function(){l("gridBudgetCapex")}),$(r.container).keydown(function(t){if(t.keyCode==9){var u=$("#gridBudgetCapex").data("kendoGrid"),r=$(this).closest("tr"),f=$("tr",u.tbody).index(r);i=Number($("td",r).index(this))+1;n=u.dataItem(r)}}))):this.closeCell())}catch(o){h={method:"budgetCapexGrid(edit)",exceptionMessage:"message:"+o.message+" stack:"+o.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",h)).then(function(){alert(errormessage)})}},dataBound:function(){var l=$("#gridBudgetCapex").data("kendoGrid"),i=l.dataSource.data(),r,u,h,c;for($.each(i,function(n,t){e.dsBudgetData[0].PreliminaryCount===0?t.Active!="Current"?$('tr[data-uid="'+t.uid+'"] ').css("background-color","#f1f1f1"):$('tr[data-uid="'+t.uid+'"] ').css("background-color","white"):t.Active!="Preliminary"?$('tr[data-uid="'+t.uid+'"] ').css("background-color","#f1f1f1"):$('tr[data-uid="'+t.uid+'"] ').css("background-color","white")}),i=this._data.filter(function(n){return e.dsBudgetData[0].PreliminaryCount===0?n.Active=="Current":n.Active=="Preliminary"}).map(function(n){return n}),r=0;r<i.length;r++){var o=i[r],f=o.ActualMonths,s=5,t=$("#gridBudgetCapex").find("[data-uid='"+o.uid+"']"),n=$("td:nth-child(17)",t);for(n.addClass("budgetActuals"),n=$("td:nth-child(18)",t),n.addClass("budgetActuals"),n=$("td:nth-child(23)",t),n.addClass("budgetActuals"),n=$("td:nth-child(3)",t),n.addClass("budgetActuals"),n=$("td:nth-child(4)",t),n.addClass("budgetActuals"),u=0;u<f;u++)h=$("td:nth-child("+(s+u)+")",t),h.addClass("budgetActuals");e.dsBudgetData[0].PreliminaryCount!=0&&f!="12"&&(c=$("td:nth-child("+(s+parseInt(f))+")",t),c.addClass("PrelimItalic"))}}});t=$("#gridBudgetCapex").data("kendoGrid");$(t.tbody).on("click","td",function(){var r=$(this).closest("tr"),u=$("tr",t.tbody).index(r);i=$("td",r).index(this);n=t.dataItem(r)});t.element.on("keydown",function(t){var r,o;try{t.keyCode===86&&t.ctrlKey===!0&&e.IsOpen&&(r=$("#ta"),r.val(""),r.focus(),setTimeout(function(){for(var s,f,a,e,t,v=$.trim(r.val()),h=$("#gridBudgetCapex").data("kendoGrid"),c=v.split("\n"),u=[],o=0;o<c.length;o++)for(s=c[o].split("\t"),f=0;f<s.length;f++)u.push(s[f]);for(a=$("#gridBudgetCapex").data("kendoGrid").columns,e=i;e<a.length&&u.length>0;e++)t=$(h.thead.find("th")[e]).attr("data-field"),t!="Y1"&&t!="Active"&&t!="Historical"&&t!="AnnualTotal"&&t!="CumulativeTotal"&&(n.ActualMonths!=null?n.ActualMonths.indexOf(t)==-1&&n.set(t,u.shift()):n.set(t,u.shift()));h.refresh();l("gridBudgetCapex");r.val("")},1))}catch(u){o={method:"budgetCapexGrid(keydown)",exceptionMessage:"message:"+u.message+" stack:"+u.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",o)).then(function(){alert(errormessage)})}})}function lt(){var t=0,i=null,r=new kendo.data.DataSource({transport:{read:function(n){n.success(e.capexForecastY1)}},sort:[{field:"Active",dir:"desc"}],schema:{model:{id:"BudgetDataID",fields:{BudgetDataID:{hidden:!0},Active:{editable:!1},LocalCurrencyAbbreviation:{editable:!1},Apr:{type:"number"},May:{type:"number"},Jun:{type:"number"},Jul:{type:"number"},Aug:{type:"number"},Sep:{type:"number"},Oct:{type:"number"},Nov:{type:"number"},Dec:{type:"number"},Jan:{type:"number"},Feb:{type:"number"},Mar:{type:"number"}}}}}),u=[{field:"BudgetDataID",hidden:!0},{field:"Active",title:h[6].TblLabel,headerAttributes:{"class":"wrap-header"},width:"10%",editable:!1},{field:"LocalCurrencyAbbreviation",title:"Currency",headerAttributes:{"class":"wrap-header"},width:"5%",editable:!1,attributes:{"class":"txt-float-R"}},{field:"Apr",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"May",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Jun",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Jul",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Aug",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Sep",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Oct",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Nov",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Dec",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Jan",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Feb",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Mar",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}}],n;$("#gridBudgetCapexY1").kendoGrid({columns:u,dataSource:r,editable:!0,navigatable:!0,edit:function(n){var r,u,h;try{e.IsOpen?(r=this,u=r.columns[n.container.index()].field,$("[name='"+u+"']",n.container).blur(function(){ut()}),$(n.container).keydown(function(n){if(n.keyCode==9){var u=$("#gridBudgetCapexY1").data("kendoGrid"),r=$(this).closest("tr"),f=$("tr",u.tbody).index(r);t=Number($("td",r).index(this))+1;i=u.dataItem(r);console.log(f+t+i)}})):this.closeCell()}catch(o){h={method:"budgetCapexGridY1(edit)",exceptionMessage:"message:"+o.message+" stack:"+o.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",h)).then(function(){alert(errormessage)})}},allowCopy:!0});n=$("#gridBudgetCapexY1").data("kendoGrid");$(n.tbody).on("click","td",function(){var r=$(this).closest("tr"),u=$("tr",n.tbody).index(r);t=$("td",r).index(this);i=n.dataItem(r)});n.element.on("keydown",function(n){var r,e;try{n.keyCode===86&&n.ctrlKey===!0&&(r=$("#ta"),r.val(""),r.focus(),setTimeout(function(){for(var o,n,l,u,s,a=$.trim(r.val()),h=$("#gridBudgetCapexY1").data("kendoGrid"),c=a.split("\n"),f=[],e=0;e<c.length;e++)for(o=c[e].split("\t"),n=0;n<o.length;n++)f.push(o[n]);for(l=$("#gridBudgetCapexY1").data("kendoGrid").columns,u=t;u<l.length&&f.length>0;u++)s=$(h.thead.find("th")[u]).attr("data-field"),s!="Active"&&i.set(s,f.shift());h.refresh();ut();r.val("")},1))}catch(u){e={method:"budgetCapexGridY1(keydown)",exceptionMessage:"message:"+u.message+" stack:"+u.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",e)).then(function(){alert(errormessage)})}})}function at(){var i=0,n=null,r=new kendo.data.DataSource({transport:{read:function(n){n.success(e.opexForecast)}},sort:[{field:"ActiveOrder",dir:"asc"}],schema:{model:{id:"BudgetDataID",fields:{BudgetDataID:{hidden:!0},Active:{editable:!1},LocalCurrencyAbbreviation:{editable:!1},Historical:{type:"number",editable:!1},Apr:{type:"number"},May:{type:"number"},Jun:{type:"number"},Jul:{type:"number"},Aug:{type:"number"},Sep:{type:"number"},Oct:{type:"number"},Nov:{type:"number"},Dec:{type:"number"},Jan:{type:"number"},Feb:{type:"number"},Mar:{type:"number"},AnnualTotal:{type:"number",editable:!1},Y1:{type:"number",editable:!1},Y2:{type:"number"},Y3:{type:"number"},Y4:{type:"number"},Y5:{type:"number"},CumulativeTotal:{type:"number",editable:!1}}}}}),u=[{field:"BudgetDataID",hidden:!0},{field:"Active",title:"Reference",headerAttributes:{"class":"wrap-header"},width:"5%"},{field:"LocalCurrencyAbbreviation",title:"Currency",headerAttributes:{"class":"wrap-header"},width:"4%",editable:!1},{field:"Historical",headerAttributes:{"class":"wrap-header"},width:"5%",format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Apr",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"May",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Jun",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Jul",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Aug",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Sep",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Oct",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Nov",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Dec",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Jan",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Feb",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Mar",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"AnnualTotal",title:h[0].TblLabel,editable:!1,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Y1",title:h[1].TblLabel,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Y2",title:h[2].TblLabel,editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Y3",title:h[3].TblLabel,editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Y4",title:h[4].TblLabel,editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Y5",title:h[5].TblLabel,editor:o,format:"{0:#,#}",headerAttributes:{"class":"wrap-header"},attributes:{"class":"txt-float-R"}},{field:"CumulativeTotal",title:"Total OPEX",headerAttributes:{"class":"wrap-header"},editable:!1,format:"{0:#,#}",attributes:{"class":"txt-float-R"}}],t;$("#gridBudgetOpex").kendoGrid({columns:u,dataSource:r,editable:!0,navigatable:!0,allowCopy:!0,edit:function(r){var u,h;try{r.model.Active=="Previous"||r.model.Active=="Plan"?this.closeCell():(e.dsBudgetData[0].PreliminaryCount!=0&&r.model.Active=="Current"&&this.closeCell(),e.IsOpen?(u=t.columns[r.container.index()].field,p.indexOf(u)!=-1&&p.indexOf(u)<r.model.ActualMonths?this.closeCell():($("[name='"+u+"']",r.container).blur(function(){l("gridBudgetOpex")}),$(r.container).keydown(function(t){if(t.keyCode==9){var u=$("#gridBudgetOpex").data("kendoGrid"),r=$(this).closest("tr"),f=$("tr",u.tbody).index(r);i=Number($("td",r).index(this))+1;n=u.dataItem(r);console.log(f+i+n)}}))):this.closeCell())}catch(o){h={method:"budgetOpexGrid(edit)",exceptionMessage:"message:"+o.message+" stack:"+o.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",h)).then(function(){alert(errormessage)})}},dataBound:function(){var l=$("#gridBudgetOpex").data("kendoGrid"),i=l.dataSource.data(),r,u,h,c;for($.each(i,function(n,t){e.dsBudgetData[0].PreliminaryCount===0?t.Active!="Current"?$('tr[data-uid="'+t.uid+'"] ').css("background-color","#f1f1f1"):$('tr[data-uid="'+t.uid+'"] ').css("background-color","white"):t.Active!="Preliminary"?$('tr[data-uid="'+t.uid+'"] ').css("background-color","#f1f1f1"):$('tr[data-uid="'+t.uid+'"] ').css("background-color","white")}),i=this._data.filter(function(n){return e.dsBudgetData[0].PreliminaryCount===0?n.Active=="Current":n.Active=="Preliminary"}).map(function(n){return n}),r=0;r<i.length;r++){var o=i[r],f=o.ActualMonths,s=5,t=$("#gridBudgetOpex").find("[data-uid='"+o.uid+"']"),n=$("td:nth-child(17)",t);for(n.addClass("budgetActuals"),n=$("td:nth-child(18)",t),n.addClass("budgetActuals"),n=$("td:nth-child(23)",t),n.addClass("budgetActuals"),n=$("td:nth-child(3)",t),n.addClass("budgetActuals"),n=$("td:nth-child(4)",t),n.addClass("budgetActuals"),u=0;u<f;u++)h=$("td:nth-child("+(s+u)+")",t),h.addClass("budgetActuals");e.dsBudgetData[0].PreliminaryCount!=0&&f!="12"&&(c=$("td:nth-child("+(s+parseInt(f))+")",t),c.addClass("PrelimItalic"))}}});t=$("#gridBudgetOpex").data("kendoGrid");$(t.tbody).on("click","td",function(){var r=$(this).closest("tr"),u=$("tr",t.tbody).index(r);i=$("td",r).index(this);n=t.dataItem(r)});t.element.on("keydown",function(t){var r,e;try{t.keyCode===86&&t.ctrlKey===!0&&(r=$("#ta"),r.val(""),r.focus(),setTimeout(function(){for(var s,f,a,e,t,v=$.trim(r.val()),h=$("#gridBudgetOpex").data("kendoGrid"),c=v.split("\n"),u=[],o=0;o<c.length;o++)for(s=c[o].split("\t"),f=0;f<s.length;f++)u.push(s[f]);for(a=$("#gridBudgetOpex").data("kendoGrid").columns,e=i;e<a.length&&u.length>0;e++)t=$(h.thead.find("th")[e]).attr("data-field"),t!="Y1"&&t!="Active"&&t!="Historical"&&t!="AnnualTotal"&&t!="CumulativeTotal"&&(n.ActualMonths!=null?n.ActualMonths.indexOf(t)==-1&&n.set(t,u.shift()):n.set(t,u.shift()));h.refresh();l("gridBudgetOpex");r.val("")},1))}catch(u){e={method:"budgetOpexGrid(keydown)",exceptionMessage:"message:"+u.message+" stack:"+u.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",e)).then(function(){alert(errormessage)})}})}function vt(){var t=0,i=null,r=new kendo.data.DataSource({transport:{read:function(n){n.success(e.opexForecastY1)}},schema:{model:{id:"BudgetDataID",fields:{BudgetDataID:{hidden:!0},Active:{editable:!1},LocalCurrencyAbbreviation:{editable:!1},Jan:{type:"number"},Feb:{type:"number"},Mar:{type:"number"},Apr:{type:"number"},May:{type:"number"},Jun:{type:"number"},Jul:{type:"number"},Aug:{type:"number"},Sep:{type:"number"},Oct:{type:"number"},Nov:{type:"number"},Dec:{type:"number"}}}}}),u=[{field:"BudgetDataID",hidden:!0},{field:"Active",title:h[7].TblLabel,headerAttributes:{"class":"wrap-header"},width:"10%"},{field:"LocalCurrencyAbbreviation",title:"Currency",headerAttributes:{"class":"wrap-header"},width:"5%",editable:!1,attributes:{"class":"txt-float-R"}},{field:"Apr",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"May",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Jun",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Jul",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Aug",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Sep",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Oct",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Nov",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Dec",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Jan",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Feb",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}},{field:"Mar",editor:o,format:"{0:#,#}",attributes:{"class":"txt-float-R"}}],n;$("#gridBudgetOpexY1").kendoGrid({columns:u,dataSource:r,editable:!0,navigatable:!0,allowCopy:!0,edit:function(n){var r,u,h;try{e.IsOpen?(r=this,u=r.columns[n.container.index()].field,$("[name='"+u+"']",n.container).blur(function(){ft()}),$(n.container).keydown(function(n){if(n.keyCode==9){var u=$("#gridBudgetOpexY1").data("kendoGrid"),r=$(this).closest("tr"),f=$("tr",u.tbody).index(r);t=Number($("td",r).index(this))+1;i=u.dataItem(r);console.log(f+t+i)}})):this.closeCell()}catch(o){h={method:"budgetOpexGridY1(edit)",exceptionMessage:"message:"+o.message+" stack:"+o.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",h)).then(function(){alert(errormessage)})}}});n=$("#gridBudgetOpexY1").data("kendoGrid");$(n.tbody).on("click","td",function(){var r=$(this).closest("tr"),u=$("tr",n.tbody).index(r);t=$("td",r).index(this);i=n.dataItem(r)});n.element.on("keydown",function(n){var r,e;try{n.keyCode===86&&n.ctrlKey===!0&&(r=$("#ta"),r.val(""),r.focus(),setTimeout(function(){for(var o,n,l,u,s,a=$.trim(r.val()),h=$("#gridBudgetOpexY1").data("kendoGrid"),c=a.split("\n"),f=[],e=0;e<c.length;e++)for(o=c[e].split("\t"),n=0;n<o.length;n++)f.push(o[n]);for(l=$("#gridBudgetOpexY1").data("kendoGrid").columns,u=t;u<l.length&&f.length>0;u++)s=$(h.thead.find("th")[u]).attr("data-field"),s!="Active"&&i.set(s,f.shift());h.refresh();ft();r.val("")},1))}catch(u){e={method:"budgetOpexGridY1(keydown)",exceptionMessage:"message:"+u.message+" stack:"+u.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",e)).then(function(){alert(errormessage)})}})}function yt(){var n,r,o,t,h,i,c,u;if(displayLoading(),n=null,r=!0,$("#gridbudgetIO").data("kendoGrid")!=undefined)for(n=$("#gridbudgetIO").data("kendoGrid").dataSource.data(),o=$("#gridbudgetIO").data("kendoGrid").dataSource.data().filter(function(n){return n.dirty}).map(function(n){return n}),t=0;t<n.length;t++){if(n[t].BudgetIO==""){i=missingBudgetIOmessage;$.each(n,function(n,t){t.BudgetIO==""&&$('tr[data-uid="'+t.uid+'"] ').children().eq(0).css("background-color","yellow")});alert(i);hideLoading();return}if(n[t].InvestmentOrder.length>12&&r==!0&&(r=!1),o.length>0&&(h=n.filter(function(i){return i.BudgetIO==n[t].BudgetIO}),h.length>1)){i=duplicateBudgetIOmessage;i=i.replace("value",n[t].BudgetIO);alert(i);hideLoading();return}}if(r,r==!1&&!confirm(projectInvestmentOrderRange)){hideLoading();return}e.SelectedBudget.CapitalBudgetID!=null&&e.SelectedBudget.CapitalBudgetID!=""?v==!0?(u={ProjectID:SeletedProjectId,BudgetID:e.SelectedBudget.CapitalBudgetID,BudgetIO:JSON.stringify(n)},f.postDataWCFAsync("checkBudgetUnqiueID",u).then(function(n){var t,i,r,e;try{if(t=JSON.parse(n),t.length>0&&t[0].BudgetIDCount==0&&t[0].BudgetIOCount==0)g();else{t[0].BudgetIDCount>0&&alert(duplicateBudgetIDmessage);t[0].BudgetIOCount>0&&(i=duplicateBudgetIOmessage,r=t[0].BudgetIODuplicate.substr(0,t[0].BudgetIODuplicate.length-2),i=i.replace("value",r),alert(i));hideLoading();return}}catch(u){e={method:"updateBudgetdata",exceptionMessage:"message:"+u.message+" stack:"+u.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",e)).then(function(){alert(errormessage)});hideLoading()}})):(c={ProjectID:SeletedProjectId,BudgetID:e.SelectedBudget.CapitalBudgetID,BudgetIO:JSON.stringify(n)},f.postDataWCFAsync("checkBudgetUnqiueID",c).then(function(n){var t,i,r,e;try{if(t=JSON.parse(n),t.length>0&&t[0].BudgetIDCount==0&&t[0].BudgetIOCount==0)g();else{t[0].BudgetIDCount>0&&alert(duplicateBudgetIDmessage);t[0].BudgetIOCount>0&&(i=duplicateBudgetIOmessage,r=t[0].BudgetIODuplicate.substr(0,t[0].BudgetIODuplicate.length-2),i=i.replace("value",r),alert(i));hideLoading();return}}catch(u){e={method:"updateBudgetdata",exceptionMessage:"message:"+u.message+" stack:"+u.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",e)).then(function(){alert(errormessage)});hideLoading()}})):(u={ProjectID:SeletedProjectId,BudgetID:"",BudgetIO:JSON.stringify(n)},f.postDataWCFAsync("checkBudgetUnqiueID",u).then(function(n){var t,i,r,e;try{if(t=JSON.parse(n),t.length>0&&t[0].BudgetIOCount==0)g();else{i=duplicateBudgetIOmessage;r=t[0].BudgetIODuplicate.substr(0,t[0].BudgetIODuplicate.length-2);i=i.replace("value",r);alert(i);hideLoading();return}}catch(u){e={method:"updateBudgetdata",exceptionMessage:"message:"+u.message+" stack:"+u.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",e)).then(function(){alert(errormessage)});hideLoading()}}))}function g(){var p,o,b,h,l,u;try{var t=!0,g=e.SelectedBudget.APISDate!=null&&e.SelectedBudget.APISDate!=""?$("#APISDate").val():null,y=e.SelectedBudget.DefinitiveCRApprovalDate!=null&&e.SelectedBudget.DefinitiveCRApprovalDate!=""?$("#definitiveCRApprovalDate").val():null,r=e.SelectedBudget.FundingApprovalNeedDate!=null&&e.SelectedBudget.FundingApprovalNeedDate!=""?$("#fundingNeedDate").val():null;if(e.SelectedBudget.CapExRequired.LookUpMemberID=="1"&&(e.SelectedBudget.CapitalBudgetID==null||e.SelectedBudget.CapitalBudgetID==""||e.SelectedBudget.WhereID==null||e.SelectedBudget.WhereID==""||e.SelectedBudget.WhyID==null||e.SelectedBudget.WhyID==""||e.SelectedBudget.PredefinedInvestmentID==null||e.SelectedBudget.PredefinedInvestmentID==""||r==null||e.SelectedBudget.BudgetOwner==null||e.SelectedBudget.BudgetOwner==""?(t=!1,alert(capexYesMandatory),document.getElementById("budgetId").style.backgroundColor=e.SelectedBudget.CapitalBudgetID==null||e.SelectedBudget.CapitalBudgetID==""?"yellow":"white",e.SelectedBudget.BudgetOwner==null||e.SelectedBudget.BudgetOwner==""?(p=$("#budgetOwner").data("kendoComboBox"),p.wrapper.find(".k-input").attr("style","background: yellow !important")):$("#budgetOwner").data("kendoComboBox").wrapper.find(".k-input").attr("style","background: white !important"),e.SelectedBudget.WhereID==null||e.SelectedBudget.WhereID==""?$("#Where").data("kendoComboBox").wrapper.find(".k-input").attr("style","background: yellow !important"):$("#Where").data("kendoComboBox").wrapper.find(".k-input").attr("style","background: white !important"),e.SelectedBudget.WhyID==null||e.SelectedBudget.WhyID==""?$("#Why").data("kendoComboBox").wrapper.find(".k-input").attr("style","background: yellow !important"):$("#Why").data("kendoComboBox").wrapper.find(".k-input").attr("style","background: white !important"),e.SelectedBudget.PredefinedInvestmentID==null||e.SelectedBudget.PredefinedInvestmentID==""?$("#preDefinedInvest").data("kendoComboBox").wrapper.find(".k-input").attr("style","background: yellow !important"):$("#preDefinedInvest").data("kendoComboBox").wrapper.find(".k-input").attr("style","background: white !important"),r==null?$("#fundingNeedDate").data("kendoDatePicker").wrapper.find(".k-input").attr("style","background: yellow !important"):$("#fundingNeedDate").data("kendoDatePicker").wrapper.find(".k-input").attr("style","background: white !important")):!a&&e.isCapexRequiredEditable&&(t=confirm(capexYeslockedMsg)?!0:!1)),r!=null&&(parseDate(r)?e.fundingNeedDateError=!1:(t=!1,e.fundingNeedDateError=!0)),y!=null&&(parseDate(y)?e.definitiveCRDateError=!1:(t=!1,e.definitiveCRDateError=!0)),!t){hideLoading();return}o=[];b=[];document.getElementById("budgetId").style.backgroundColor="white";$("#budgetOwner").data("kendoComboBox").wrapper.find(".k-input").attr("style","background: white !important");$("#Where").data("kendoComboBox").wrapper.find(".k-input").attr("style","background: white !important");$("#Why").data("kendoComboBox").wrapper.find(".k-input").attr("style","background: white !important");$("#preDefinedInvest").data("kendoComboBox").wrapper.find(".k-input").attr("style","background: white !important");$("#fundingNeedDate").data("kendoDatePicker").wrapper.find(".k-input").attr("style","background: white !important");e.budgetData={ProjectID:SeletedProjectId,BudgetID:e.SelectedBudget.BudgetID,CapExRequired:e.SelectedBudget.CapExRequired!=null?e.SelectedBudget.CapExRequired.LookUpMemberID:null,OpExRequired:e.SelectedBudget.OpExRequired!=null?e.SelectedBudget.OpExRequired.LookUpMemberID:null,TotalApprovedCapEx:e.SelectedBudget.TotalApprovedCapEx!=null&&e.SelectedBudget.TotalApprovedCapEx!=""?e.SelectedBudget.TotalApprovedCapEx:null,TotalApprovedOpEx:e.SelectedBudget.TotalApprovedOpEx!=null&&e.SelectedBudget.TotalApprovedOpEx!=""?e.SelectedBudget.TotalApprovedOpEx:null,CapitalBudgetID:e.SelectedBudget.CapitalBudgetID!=null?e.SelectedBudget.CapitalBudgetID:null,APISDate:e.SelectedBudget.APISDate!=null&&e.SelectedBudget.APISDate!=""?e.SelectedBudget.APISDate:null,FundingStatusID:e.SelectedBudget.FundingStatusID!=null?e.SelectedBudget.FundingStatusID.LookUpMemberID:null,DefinitiveCRID:e.SelectedBudget.DefinitiveCRID!=null?e.SelectedBudget.DefinitiveCRID:null,DefinitiveCRApprovalDate:e.SelectedBudget.DefinitiveCRApprovalDate!=null&&e.SelectedBudget.DefinitiveCRApprovalDate!=""?e.SelectedBudget.DefinitiveCRApprovalDate:null,PredefinedInvestmentID:e.SelectedBudget.PredefinedInvestmentID!=null?e.SelectedBudget.PredefinedInvestmentID.LookUpMemberID:null,WhereID:e.SelectedBudget.WhereID!=null?e.SelectedBudget.WhereID.LookUpMemberID:null,WhyID:e.SelectedBudget.WhyID!=null?e.SelectedBudget.WhyID.LookUpMemberID:null,FundingApprovalNeedDate:e.SelectedBudget.FundingApprovalNeedDate!=null&&e.SelectedBudget.FundingApprovalNeedDate!=""?e.SelectedBudget.FundingApprovalNeedDate:null,LocalCurrencyID:e.SelectedBudget.LocalCurrencyID!=null?e.SelectedBudget.LocalCurrencyID.LookUpMemberID:null,BudgetComment:e.SelectedBudget.BudgetComment,BudgetOwner:e.SelectedBudget.BudgetOwner!=null?e.SelectedBudget.BudgetOwner.PortfolioOwnerID:null};o.push(e.budgetData);h=[];$("#gridbudgetIO").data("kendoGrid")!=undefined&&(l=$("#gridbudgetIO").data("kendoGrid").dataSource.data().filter(function(n){return n.dirty}).map(function(n){return n}),l.length>0&&angular.forEach(l,function(n){var t={};t.BudgetIOID=n.BudgetIOID;t.BudgetIO=n.BudgetIO;t.InvestmentOrder=n.InvestmentOrder;t.CARApprovalDate=kendo.toString(n.CARApprovalDate,"d");t.CARApprovedCAPEX=n.CARApprovedCAPEX;t.CARApprovedOPEX=n.CARApprovedOPEX;t.SpendStartDate=n.SpendStartDate;t.SpendEndDate=n.SpendEndDate;t.FinancialClosureDate=n.FinancialClosureDate;h.push(t)}));u={ProjectID:SeletedProjectId,objBudgetData:JSON.stringify(o),objCapexGridData:JSON.stringify([]),objCapexGridDataY1:JSON.stringify([]),objOpexGridData:JSON.stringify([]),objOpexGridDataY1:JSON.stringify([]),objBudgetIO:JSON.stringify(h),objBudgetIODelete:JSON.stringify(d)};f.postDataWCFAsync("updateProjectBudget",u).then(function(t){t=="Success"?(e.SelectedBudget.CapExRequired.LookUpMemberName=="Yes"&&(et=0),ot=!1,$.when(f.postDataWCFAsync("getProjectBudgetByID",SeletedProjectId),f.postDataWCFAsync("getBudgetIO",SeletedProjectId)).then(function(t,r){var u,o,l;try{e.dsBudgetData=JSON.parse(t.getProjectBudgetByIDResult);e.SelectedBudget=e.dsBudgetData[0];e.SelectedBudget.CapitalBudgetID==""||e.SelectedBudget.CapitalBudgetID==null?(v=!0,e.isBudgetIdEditable=!0):(v=!1,u=c.filter(function(n){return n.Permission==EditBudgetIDPerm}),e.isBudgetIdEditable=u.length>0?!0:!1);e.SelectedBudget.CapExRequired==!0?(o=c.filter(function(n){return n.Permission==EditCapexRequiredPerm}),e.isCapexRequiredEditable=o.length>0?!0:!1):e.isCapexRequiredEditable=!0;tt();d=[];k=JSON.parse(r.getBudgetIOResult);$("#gridbudgetIO").data("kendoGrid").dataSource.read();i.$digest();n.$emit("UpdateHubStatus")}catch(h){l={method:"updateBudgetdata",exceptionMessage:"message:"+h.message+" stack:"+h.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",l)).then(function(){alert(errormessage)});hideLoading()}}),hideLoading()):(hideLoading(),alert("Error occurred in Budget data update."))})}catch(w){u={method:"updateBudgetdata",exceptionMessage:"message:"+w.message+" stack:"+w.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",u)).then(function(){alert(errormessage)});hideLoading()}}function pt(){try{f.postDataWCFAsync("getProjectCurrentState",SeletedProjectId).then(function(t){var r=JSON.parse(t.getProjectCurrentStateResult);if(r[0].PhaseStateID==cancelStateID){alert(cancelForecast);return}displayLoading();var u=e.SelectedBudget.CapExRequired.LookUpMemberID=="1"?it("gridBudgetCapex"):[],o=e.SelectedBudget.CapExRequired.LookUpMemberID=="1"?rt("gridBudgetCapexY1"):[],h=e.SelectedBudget.OpExRequired.LookUpMemberID=="1"?it("gridBudgetOpex"):[],c=e.SelectedBudget.OpExRequired.LookUpMemberID=="1"?rt("gridBudgetOpexY1"):[],l={ProjectID:SeletedProjectId,objBudgetData:JSON.stringify([]),objCapexGridData:JSON.stringify(u),objCapexGridDataY1:JSON.stringify(o),objOpexGridData:JSON.stringify(h),objOpexGridDataY1:JSON.stringify(c),objBudgetIO:JSON.stringify([]),objBudgetIODelete:JSON.stringify([])};f.postDataWCFAsync("updateProjectBudget",l).then(function(t){t=="Success"?($.when(f.postDataWCFAsync("getProjectBudgetByID",SeletedProjectId),f.postDataWCFAsync("getProjectBudgetForecastDataY1",SeletedProjectId),f.postDataWCFAsync("getProjectBudgetForecastData",SeletedProjectId)).then(function(t,r,u){try{e.dsForecastDataY1=JSON.parse(r.getProjectBudgetForecastDataY1Result);e.dsForecastData=JSON.parse(u.getProjectBudgetForecastDataResult);e.dsBudgetData=JSON.parse(t.getProjectBudgetByIDResult);e.SelectedBudget=e.dsBudgetData[0];tt();e.capexForecast=JSON.parse(u.getProjectBudgetForecastDataResult).filter(function(n){return n.BudgetDataTypeID==capexID}).reverse();e.opexForecast=JSON.parse(u.getProjectBudgetForecastDataResult).filter(function(n){return n.BudgetDataTypeID==opexID}).reverse();e.capexForecastY1=JSON.parse(r.getProjectBudgetForecastDataY1Result).filter(function(n){return n.BudgetDataTypeID==capexID});e.opexForecastY1=JSON.parse(r.getProjectBudgetForecastDataY1Result).filter(function(n){return n.BudgetDataTypeID==opexID});y=e.SelectedBudget.PreliminaryCount>0?1:0;y==1?(e.capexForecastCommittedSpend=e.capexForecast.filter(function(n){return n.ActiveID==preliminary})[0].CommittedSpend,e.opexForecastCommittedSpend=e.opexForecast.filter(function(n){return n.ActiveID==preliminary})[0].CommittedSpend):(e.capexForecastCommittedSpend=e.capexForecast.filter(function(n){return n.ActiveID==currentForecastId})[0].CommittedSpend,e.opexForecastCommittedSpend=e.opexForecast.filter(function(n){return n.ActiveID==currentForecastId})[0].CommittedSpend);$("#gridBudgetOpexY1").data("kendoGrid").dataSource.read();$("#gridBudgetOpex").data("kendoGrid").dataSource.read();$("#gridBudgetCapexY1").data("kendoGrid").dataSource.read();$("#gridBudgetCapex").data("kendoGrid").dataSource.read();i.$digest();n.$emit("UpdateHubStatus")}catch(o){var h={method:"UpdateForecastdata",exceptionMessage:"message:"+o.message+" stack:"+o.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",h)).then(function(){alert(errormessage)});hideLoading()}}),hideLoading()):(hideLoading(),alert("Error occurred in Forecast data update."))})})}catch(t){var r={method:"UpdateForecastdata",exceptionMessage:"message:"+t.message+" stack:"+t.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",r)).then(function(){alert(errormessage)});hideLoading()}}function it(n){var f=[],r,u,i,t;if($("#"+n).data("kendoGrid")!=undefined)return r=$("#"+n).data("kendoGrid").dataSource.data(),u=e.dsBudgetData[0].PreliminaryCount===0?r.filter(function(n){return n.id!=""&&n.id!=null&&n.Active=="Current"}).map(function(n){return n}):r.filter(function(n){return n.id!=""&&n.id!=null&&n.Active=="Preliminary"}).map(function(n){return n}),u.length>0&&(i=u[0],t={},t.BudgetDataID=i.BudgetDataID,t.BudgetGlobalID=i.BudgetGlobalID,t.ProjectID=i.ProjectID,t.BudgetDataTypeID=i.BudgetDataTypeID,t.Active=i.Active,t.Jan=i.Jan,t.Feb=i.Feb,t.Mar=i.Mar,t.Apr=i.Apr,t.May=i.May,t.Jun=i.Jun,t.Jul=i.Jul,t.Aug=i.Aug,t.Sep=i.Sep,t.Oct=i.Oct,t.Nov=i.Nov,t.Dec=i.Dec,n=="gridBudgetCapex"&&(t.AFPDeviationCodeID=e.SelectedBudget.AFPDeviationCodeID!=null?e.SelectedBudget.AFPDeviationCodeID.LookUpMemberID:null,t.MTDPDeviationCodeID=e.SelectedBudget.MTDPDeviationCodeID!=null?e.SelectedBudget.MTDPDeviationCodeID.LookUpMemberID:null),t.Y1=i.Y1,t.Y2=i.Y2,t.Y3=i.Y3,t.Y4=i.Y4,t.Y5=i.Y5,t.AnnualTotal=i.AnnualTotal,t.CumulativeTotal=i.CumulativeTotal,t.CommittedSpend=n==="gridBudgetCapex"?e.capexForecastCommittedSpend:e.opexForecastCommittedSpend,t.SubmittedByID=currentUserId,f.push(t)),f}function rt(n){var f=[],r,u,i,t;if($("#"+n).data("kendoGrid")!=undefined)return r=$("#"+n).data("kendoGrid").dataSource.data(),u=e.dsBudgetData[0].PreliminaryCount===0?r.filter(function(n){return n.id!=""&&n.id!=null&&n.Active=="Current"}).map(function(n){return n}):r.filter(function(n){return n.id!=""&&n.id!=null&&n.Active=="Preliminary"}).map(function(n){return n}),u.length>0&&(i=u[0],t={},t.BudgetDataID=i.BudgetDataID,t.BudgetGlobalID=i.BudgetGlobalID,t.ProjectID=i.ProjectID,t.BudgetDataTypeID=i.BudgetDataTypeID,t.Jan=i.Jan,t.Feb=i.Feb,t.Mar=i.Mar,t.Apr=i.Apr,t.May=i.May,t.Jun=i.Jun,t.Jul=i.Jul,t.Aug=i.Aug,t.Sep=i.Sep,t.Oct=i.Oct,t.Nov=i.Nov,t.Dec=i.Dec,f.push(t)),f}function wt(){var n,t,u;try{n=[{field:"BudgetIO",title:"CAR ID",headerAttributes:{"class":"wrap-header"},editable:!1},{field:"InvestmentOrder",title:"Investment Order",headerAttributes:{"class":"wrap-header"}},{field:"CARApprovalDate",title:"CAR Approval Date",headerAttributes:{"class":"wrap-header"},format:"{0:MM/dd/yyyy}"},{field:"CARApprovedCAPEX",title:"CAR Approved CAPEX "+e.LocalCurrencyAbb,headerAttributes:{"class":"wrap-header"},format:"{0:#,#}"},{field:"CARApprovedOPEX",title:"CAR Approved OPEX "+e.LocalCurrencyAbb,headerAttributes:{"class":"wrap-header"},format:"{0:#,#}"},{field:"SpendStartDate",title:"Start Date",headerAttributes:{"class":"wrap-header"},format:"{0:MM/dd/yyyy}",hidden:!0},{field:"SpendEndDate",title:"End Date",headerAttributes:{"class":"wrap-header"},format:"{0:MM/dd/yyyy}",hidden:!0},{field:"FinancialClosureDate",title:"Financial Closure Date",headerAttributes:{"class":"wrap-header"},format:"{0:MM/dd/yyyy}",hidden:!0},{hidden:!(e.isEditable&&e.isDeleteBudgetIO),command:[{name:" ",iconClass:"k-icon k-i-close",width:"10%",click:function(n){var r,t,u;confirm(gridDeleteMessage)?(n.preventDefault(),r=$(n.target).closest("tr"),t=this.dataItem(r),t.BudgetIOID!="undefined"&&t.BudgetIOID!=""&&t.BudgetIOID!=null&&d.push({BudgetIOID:t.BudgetIOID}),u=$("#gridbudgetIO").data("kendoGrid"),u.removeRow(r),i.$digest()):n.preventDefault()}}]}];t=new kendo.data.DataSource({transport:{read:function(n){n.success(k)}},schema:{model:{id:"BudgetIOID",fields:{BudgetIOID:{editable:!1,nullable:!0},BudgetIO:{type:"string"},InvestmentOrder:{type:"string"},CARApprovalDate:{type:"date",defaultValue:null},CARApprovedCAPEX:{type:"number",defaultValue:null},CARApprovedOPEX:{type:"number",defaultValue:null},SpendStartDate:{type:"date",defaultValue:null},SpendEndDate:{type:"date",defaultValue:null},FinancialClosureDate:{type:"date",defaultValue:null}}}}});$("#gridbudgetIO").kendoGrid({dataSource:t,columns:n,selectable:!0,sortable:!0,navigatable:!0,editable:{createAt:"bottom"},height:"250px",edit:function(n){var t,i,u;try{t=this;i=t.columns[n.container.index()].field;i=="BudgetIO"&&(n.model.isNew()||e.isDeleteBudgetIO||this.closeCell())}catch(r){u={method:"InitkGridBudgetIO(Edit)",exceptionMessage:"message:"+r.message+" stack:"+r.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",u)).then(function(){})}}})}catch(r){hideLoading();u={method:"InitkGridBudgetIO",exceptionMessage:"message:"+r.message+" stack:"+r.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",u)).then(function(){alert(errormessage)})}}function bt(){var n=$("#gridbudgetIO").data("kendoGrid");n.addRow()}function ut(){for(var r,u=$("#gridBudgetCapexY1").data("kendoGrid"),i=0,t=u.dataSource.view(),n=0;n<t.length;n++)t[n].Jan!=null&&(i+=t[n].Jan),t[n].Feb!=null&&(i+=t[n].Feb),t[n].Mar!=null&&(i+=t[n].Mar),t[n].Apr!=null&&(i+=t[n].Apr),t[n].May!=null&&(i+=t[n].May),t[n].Jun!=null&&(i+=t[n].Jun),t[n].Jul!=null&&(i+=t[n].Jul),t[n].Aug!=null&&(i+=t[n].Aug),t[n].Sep!=null&&(i+=t[n].Sep),t[n].Oct!=null&&(i+=t[n].Oct),t[n].Nov!=null&&(i+=t[n].Nov),t[n].Dec!=null&&(i+=t[n].Dec);if(r=$("#gridBudgetCapex").data("kendoGrid").dataSource.data().filter(function(n){return e.dsBudgetData[0].PreliminaryCount===0?n.Active=="Current":n.Active=="Preliminary"}).map(function(n){return n}),r.length>0){var f=r[0],u=$("#gridBudgetCapex").getKendoGrid(),o=u.tbody.find("tr[data-uid='"+f.uid+"']");o.find("td:eq(17)").text(kendo.format("{0:#,#}",Number(i)));f.Y1=i;l("gridBudgetCapex")}}function ft(){for(var r,u=$("#gridBudgetOpexY1").data("kendoGrid"),i=0,t=u.dataSource.view(),n=0;n<t.length;n++)t[n].Jan!=null&&(i+=t[n].Jan),t[n].Feb!=null&&(i+=t[n].Feb),t[n].Mar!=null&&(i+=t[n].Mar),t[n].Apr!=null&&(i+=t[n].Apr),t[n].May!=null&&(i+=t[n].May),t[n].Jun!=null&&(i+=t[n].Jun),t[n].Jul!=null&&(i+=t[n].Jul),t[n].Aug!=null&&(i+=t[n].Aug),t[n].Sep!=null&&(i+=t[n].Sep),t[n].Oct!=null&&(i+=t[n].Oct),t[n].Nov!=null&&(i+=t[n].Nov),t[n].Dec!=null&&(i+=t[n].Dec);if(r=$("#gridBudgetOpex").data("kendoGrid").dataSource.data().filter(function(n){return e.dsBudgetData[0].PreliminaryCount===0?n.Active=="Current":n.Active=="Preliminary"}).map(function(n){return n}),r.length>0){var f=r[0],u=$("#gridBudgetOpex").getKendoGrid(),o=u.tbody.find("tr[data-uid='"+f.uid+"']");o.find("td:eq(17)").text(kendo.format("{0:#,#}",Number(i)));f.Y1=i;l("gridBudgetOpex")}}function l(n){var r=0,u=0,t=$("#"+n).data("kendoGrid").dataSource.data().filter(function(n){return e.dsBudgetData[0].PreliminaryCount===0?n.Active=="Current":n.Active=="Preliminary"}).map(function(n){return n}),f,i,n,o;if(t.length>0){for(f=t[0],i=0;i<t.length;i++)t[i].Jan!=null&&(u+=t[i].Jan,r+=t[i].Jan),t[i].Feb!=null&&(u+=t[i].Feb,r+=t[i].Feb),t[i].Mar!=null&&(u+=t[i].Mar,r+=t[i].Mar),t[i].Apr!=null&&(u+=t[i].Apr,r+=t[i].Apr),t[i].May!=null&&(u+=t[i].May,r+=t[i].May),t[i].Jun!=null&&(u+=t[i].Jun,r+=t[i].Jun),t[i].Jul!=null&&(u+=t[i].Jul,r+=t[i].Jul),t[i].Aug!=null&&(u+=t[i].Aug,r+=t[i].Aug),t[i].Sep!=null&&(u+=t[i].Sep,r+=t[i].Sep),t[i].Oct!=null&&(u+=t[i].Oct,r+=t[i].Oct),t[i].Nov!=null&&(u+=t[i].Nov,r+=t[i].Nov),t[i].Dec!=null&&(u+=t[i].Dec,r+=t[i].Dec),t[i].Y1!=null&&(r+=t[i].Y1),t[i].Y2!=null&&(r+=t[i].Y2),t[i].Y3!=null&&(r+=t[i].Y3),t[i].Y4!=null&&(r+=t[i].Y4),t[i].Y5!=null&&(r+=t[i].Y5),t[i].Historical!=null&&(r+=t[i].Historical);f.CumulativeTotal=r;f.AnnualTotal=u;n=$("#"+n).getKendoGrid();o=n.tbody.find("tr[data-uid='"+f.uid+"']");o.find("td:eq(16)").text(kendo.format("{0:#,#}",u));o.find("td:eq(22)").text(kendo.format("{0:#,#}",r))}}function w(n){$("#"+n).on("change",function(){kt($(this).attr("id"))})}function kt(n){var t=!1,r=$("#"+n).val();if(parseDate(r)&&(t=!0),t){switch(n){case"definitiveCRApprovalDate":e.definitiveCRDateError=!1;break;case"fundingNeedDate":e.fundingNeedDateError=!1}i.$digest()}}function o(n,t){$('<input name="'+t.field+'" data-bind="value:'+t.field+'"/>').appendTo(n).kendoNumericTextBox({spinners:!1,decimals:0,format:"n0",restrictDecimals:!0,max:999999999999})}function dt(){}var e=this,s="ProjectBudgetCtrl",a=!1,b=!1,k=[],d=[],et=0,ot=!0,h=[],y=0;e.IsOpen=!0;e.dateErrorMsg=InValidDateFormat;e.dateFormatlabel=dateLabel;e.SelectedBudget={};e.dsFundingStatus=[];e.dsCapitalDeviationMonthly=[];e.dsCapitalDeviationYearly=[];e.dsCapExRequired=[];e.dsLocalCurrency=[];e.dsBudgetWhere=[];e.dsBudgetWhy=[];e.predefinedInvestment=[];e.dsBudgetOwner=[];e.SeletedProjectId="";e.LocalCurrencyAbb="";e.LocalCurrencyPlaceholderAbb="";e.capexRequired=!1;e.opexRequired=!1;e.capexOpexSubmit=!1;e.isEditable=!1;e.isCapexRequiredEditable=!1;e.isBudgetIdEditable=!1;e.isBudgetOwnerEditable=!1;var nt=!0,v=!1,c=[];e.isDeleteBudgetIO=!1;e.initProjectBudget=dt;e.updateBudgetdata=yt;e.UpdateForecastdata=pt;e.AddNewRow=bt;e.GetFxRates=st;const p=["Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar"];n.$on("getBudgetData",function(){displayLoading();ht()})}angular.module("SPOTApp").controller("ProjectBudgetCtrl",ProjectBudgetCtrl);ProjectBudgetCtrl.$inject=["$rootScope","$filter","$scope","$http","$q","GETPostService"];