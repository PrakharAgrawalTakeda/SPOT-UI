function ProjectDocumentCtrl(n,t,i,r,u,f){function c(){displayLoading();var t=[],n=[];$.when(f.postDataWCFAsync("GetTokenForDocument")).then(function(r){var e=r.GetTokenForDocumentResult,c=u.defer(),a=ProjectSiteUrl+"/_api/web/lists/getbytitle('"+o+"')/items?$select=ID,FileLeafRef,FileDirRef,FileSystemObjectType,FileRef,Modified,ServerRedirectedEmbedUri,DocIcon,EncodedAbsUrl,Editor/Title,Author/Title,CreatedByCustom,ModifiedByCustom,ModifiedTimeCustom&$expand=Editor,Author,File";$.when(f.getSharepointDocuments(a,e,o,t,c)).then(function(t){var c,a,v,u,r,p;try{h=[];l=[];c=document.createElement("a");c.href=ProjectSiteUrl;a=c;h=t;$.each(t,function(n,t){$.when(f.UpdateCreatedByModifiedByOnGetDocuments(e,t,o)).then(function(){console.log("success")})});l=t.filter(function(n){return n.FileSystemObjectType!==0});h.length>0?(r=a.pathname,r.substr(0,1)=="/"||(r="/"+r),r=decodeURIComponent(r),v=h[0].FileDirRef.replace(r,""),u=v.split("/",2),w=r+"/"+u[1],n=h.filter(function(n){return n.FileRef==w}),n.length==0&&(h.push({FileRef:r+"/"+u[1],FileDirRef:null,FileLeafRef:o,DocIcon:"",Modified:"",ServerRedirectedEmbedUri:"",FileSystemObjectType:1,Author:{Title:""},Editor:{Title:""},CreatedByCustom:"",ModifiedByCustom:"",ModifiedTimeCustom:""}),l.push({FileRef:r+"/"+u[1],FileDirRef:null,FileLeafRef:o,DocIcon:"",Modified:"",ServerRedirectedEmbedUri:"",FileSystemObjectType:1,Author:{Title:""},Editor:{Title:""},CreatedByCustom:"",ModifiedByCustom:"",ModifiedTimeCustom:""}))):(r=a.pathname,r.substr(0,1)=="/"||(r="/"+r),r=decodeURIComponent(r),w=r+"/"+docLibraryInternalName,h.push({FileRef:r+"/"+docLibraryInternalName,FileDirRef:null,FileLeafRef:o,DocIcon:"",Modified:"",ServerRedirectedEmbedUri:"",FileSystemObjectType:1,Author:{Title:""},Editor:{Title:""},CreatedByCustom:"",ModifiedByCustom:"",ModifiedTimeCustom:""}),l.push({FileRef:r+"/"+docLibraryInternalName,FileDirRef:null,FileLeafRef:o,DocIcon:"",Modified:"",ServerRedirectedEmbedUri:"",FileSystemObjectType:1,Author:{Title:""},Editor:{Title:""},CreatedByCustom:"",ModifiedByCustom:"",ModifiedTimeCustom:""}));ut?(ot(),$("#FolderTreeView").data("kendoTreeList").dataSource.read(),$("#FolderTreeViewCopy").data("kendoTreeList").dataSource.read()):(st(),ct(),lt(),$("#files").kendoUpload(),ut=!0);i.$digest();hideLoading()}catch(y){p={method:"GetSharepointDocuments",exceptionMessage:"message:"+y.message+" stack:"+y.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",p)).then(function(){alert(errormessage);hideLoading()})}})})}function ot(){var r=$("#gridProjDoc").data("kendoTreeList"),u=new kendo.data.TreeListDataSource({transport:{read:function(n){n.success(h)}},schema:{model:{id:"FileRef",parentId:"FileDirRef",fields:{FileRef:{field:"FileRef",type:"string"},FileDirRef:{field:"FileDirRef",type:"string",nullable:!0}}}},pageSize:50}),n,t,i;r.setDataSource(u);n=$("#gridProjDoc").data("kendoTreeList");t=n.dataSource.rootNodes();for(let r=0;r<t.length;r++)i=n.content.find("tr[data-uid="+t[r].uid+"]"),n.expand(i);k(n)}function st(){var n=ht();$("#gridProjDoc").kendoTreeList({dataSource:{transport:{read:function(n){n.success(h)}},schema:{model:{id:"FileRef",parentId:"FileDirRef",fields:{FileRef:{field:"FileRef",type:"string"},FileDirRef:{field:"FileDirRef",type:"string",nullable:!0}}}}},height:540,filterable:!0,sortable:!0,expand:b,collapse:b,columns:n,pageable:{pageSize:50,pageSizes:!0}});$("#gridProjDoc").kendoTooltip({filter:"button",content:function(n){var r=$(n.target).closest("tr"),t=$("#gridProjDoc").data("kendoTreeList"),u=t.dataItem(r),i;return $.each(t.columns[4].command,function(t,r){if(n.target.children().hasClass(r.imageClass))return i=r.title,!1}),i},width:100,position:"top"});$("#gridProjDoc").getKendoTreeList().one("dataBound",function(n){var t=$("#gridProjDoc").data("kendoTreeList"),i=t.dataSource.rootNodes(),r;for(let n=0;n<i.length;n++)r=t.content.find("tr[data-uid="+i[n].uid+"]"),t.expand(r);k(n.sender)});$("#gridProjDoc").getKendoTreeList().dataSource.fetch()}function ht(){return[{field:"FileLeafRef",title:"Document Name",width:"42%",template:function(n){var t="";if(n.FileSystemObjectType==0)switch(n.DocIcon){case"doc":case"docx":t="<span class='k-icon arrow k-i-doc'><\/span>"+(n.ServerRedirectedEmbedUri==null||n.ServerRedirectedEmbedUri==""?"<a href="+n.EncodedAbsUrl+" target='_blank'>"+n.FileLeafRef:"<a href="+encodeURI(n.ServerRedirectedEmbedUri)+"&action=default target='_blank'>"+n.FileLeafRef);break;case"xls":case"xlsx":t="<span class='k-icon arrow k-i-xls'><\/span>"+(n.ServerRedirectedEmbedUri==null||n.ServerRedirectedEmbedUri==""?"<a href="+n.EncodedAbsUrl+" target='_blank'>"+n.FileLeafRef:"<a href="+encodeURI(n.ServerRedirectedEmbedUri)+"&action=default target='_blank'>"+n.FileLeafRef);break;case"ppt":case"pptx":t="<span class='k-icon arrow k-i-ppt'><\/span>"+(n.ServerRedirectedEmbedUri==null||n.ServerRedirectedEmbedUri==""?"<a href="+n.EncodedAbsUrl+" target='_blank'>"+n.FileLeafRef:"<a href="+encodeURI(n.ServerRedirectedEmbedUri)+"&action=default target='_blank'>"+n.FileLeafRef);break;case"pdf":t="<span class='k-icon arrow k-i-pdf'><\/span>"+(n.ServerRedirectedEmbedUri==null||n.ServerRedirectedEmbedUri==""?"<a href="+n.EncodedAbsUrl+" target='_blank'>"+n.FileLeafRef:"<a href="+n.EncodedAbsUrl+" target='_blank'>"+n.FileLeafRef);break;case"png":case"jpg":case"gif":t="<span class='k-icon arrow k-i-image'><\/span>"+(n.ServerRedirectedEmbedUri==null||n.ServerRedirectedEmbedUri==""?"<a href="+n.EncodedAbsUrl+" target='_blank'>"+n.FileLeafRef:"<a href="+encodeURI(n.ServerRedirectedEmbedUri)+"&action=default target='_blank'>"+n.FileLeafRef);break;case"txt":t="<span class='k-icon arrow k-i-txt'><\/span>"+(n.ServerRedirectedEmbedUri==null||n.ServerRedirectedEmbedUri==""?"<a href="+n.EncodedAbsUrl+" target='_blank'>"+n.FileLeafRef:"<a href="+encodeURI(n.ServerRedirectedEmbedUri)+"&action=default target='_blank'>"+n.FileLeafRef);break;default:t="<span class='k-icon arrow k-i-"+n.DocIcon+"'><\/span>"+(n.ServerRedirectedEmbedUri==null||n.ServerRedirectedEmbedUri==""?"<a href="+n.EncodedAbsUrl+" target='_blank'>"+n.FileLeafRef:"<a href="+encodeURI(n.ServerRedirectedEmbedUri)+"&action=default target='_blank'>"+n.FileLeafRef)}else t="<span class='k-icon arrow k-i-folder'><\/span>"+n.FileLeafRef;return t}},{width:"10%",field:"ModifiedTimeCustom",title:"Modified",template:"#= (ModifiedTimeCustom ==null || ModifiedTimeCustom =='') ? '' : kendo.toString(kendo.parseDate(new Date(ModifiedTimeCustom), 'yyyy-MM-dd'), 'dd-MMM-yy hh:mm:ss tt') #"},{field:"ModifiedByCustom",title:"Modified By",width:"20%"},{field:"CreatedByCustom",title:"Created By",width:"20%"},{command:[{name:"add",title:"Create Folder",imageClass:"k-i-folder-add",className:"hiddenButton",width:"5%",text:" ",click:function(n){var i,t,r;n.preventDefault();i=$(n.target).closest("tr");t=this.dataItem(i);y="";$("#createfolder").val("");t.FileRef!=null&&(y=t.FileRef);r=$("#dialogCreateFolder");r.data("kendoWindow").open()}},{name:"delete",title:"Delete",imageClass:"k-i-close",width:"5%",className:"deleteButton",text:" ",click:function(n){n.preventDefault();var r=$(n.target).closest("tr"),t=this.dataItem(r),i;i=t.FileSystemObjectType==0?deleteDocumentMessage:deleteFolderMessage;confirm(i)?wt(t.ID,t.FileSystemObjectType):n.preventDefault()}},{name:"upload",title:"Upload File",imageClass:"k-i-upload",className:"hiddenButton",width:"5%",text:" ",click:function(n){var i,t,r,u;n.preventDefault();i=$(n.target).closest("tr");t=this.dataItem(i);a=t.FileDirRef!=null?t.FileRef:null;r=$("#files").data("kendoUpload");r.clearAllFiles();u=$("#dialogUploadDocument");u.data("kendoWindow").open()}},{name:"download",title:"Download File",imageClass:"k-i-download",width:"5%",className:"downloadButton",text:" ",click:function(n){n.preventDefault();var t=$(n.target).closest("tr"),i=this.dataItem(t),r=window.open(ProjectSiteUrl+"/_layouts/15/download.aspx?SourceUrl="+i.FileRef,"_blank")}},{name:"rename",title:"Edit Name",imageClass:"k-i-edit",width:"5%",className:"editButton",text:" ",click:function(n){var r,t,u,f;n.preventDefault();r=$(n.target).closest("tr");t=this.dataItem(r);updateId="";t.ID!=null&&(updateId=t.ID);u=$("#dialogUpdateFolderFile");u.data("kendoWindow").open();f=t.FileLeafRef.split(".");e.oldName=f[0];i.$digest()}},{name:"move",title:"Move",imageClass:"k-i-move",className:"moveButton",width:"5%",text:" ",click:function(n){var i,t,r;n.preventDefault();i=$(n.target).closest("tr");t=this.dataItem(i);d="";p="";$("#moveFilePath").val("");t.ID!=null&&(p=t.ID);t.FileRef!=null&&(d=t.FileLeafRef);r=$("#dialogMoveFile");r.data("kendoWindow").open()}},{name:"copy",title:"Copy",imageClass:"k-i-copy",className:"copyButton",width:"5%",text:" ",click:function(n){var i,t,r;n.preventDefault();i=$(n.target).closest("tr");t=this.dataItem(i);g="";nt="";t.ID!=null&&(nt=t.ID);t.FileRef!=null&&(g=t.FileLeafRef);r=$("#dialogCopyFile");r.data("kendoWindow").open()}}]}]}function ft(){return[{headerAttributes:{style:"display:none"},width:"60%",template:function(n){var t="";return n.FileSystemObjectType!==0&&(t="<span style='width:1.5em' class='k-icon arrow k-i-folder'><\/span>"+n.FileLeafRef),t}}]}function ct(){var n=ft();$("#FolderTreeView").kendoTreeList({dataSource:{transport:{read:function(n){n.success(l)}},schema:{model:{id:"FileRef",parentId:"FileDirRef",fields:{FileRef:{field:"FileRef",type:"string"},FileDirRef:{field:"FileDirRef",type:"string",nullable:!0}},expanded:!0}}},height:360,selectable:!0,sortable:!0,dataBound:et,expand:b,columns:n,pageable:{pageSize:50},change:function(){var n=$("#FolderTreeView").data("kendoTreeList");it=n.dataItem(n.select()).FileRef}})}function lt(){var n=ft();$("#FolderTreeViewCopy").kendoTreeList({dataSource:{transport:{read:function(n){n.success(l)}},schema:{model:{id:"FileRef",parentId:"FileDirRef",fields:{FileRef:{field:"FileRef",type:"string"},FileDirRef:{field:"FileDirRef",type:"string",nullable:!0}},expanded:!0}}},height:360,selectable:!0,sortable:!0,dataBound:et,expand:b,columns:n,pageable:{pageSize:50},change:function(){var n=$("#FolderTreeViewCopy").data("kendoTreeList");rt=n.dataItem(n.select()).FileRef}})}function b(n){setTimeout(function(){k(n.sender)},50)}function et(n){var t,r,i,u;try{for(t=$("#gridProjDoc").data("kendoTreeList"),r=t.dataSource.rootNodes(),i=0;i<r.length;i++)u=t.content.find("tr[data-uid="+r[i].uid+"]"),t.expand(u);k(n.sender)}catch(f){console.log(f)}}function k(n){for(var r,i=n.items(),t=0;t<i.length;t++)t==0?($(i[t]).find(".editButton").hide(),$(i[t]).find(".deleteButton").hide()):($(i[t]).find(".editButton").show(),$(i[t]).find(".deleteButton").show()),r=n.dataItem(i[t]),r.FileSystemObjectType==0?$(i[t]).find(".hiddenButton").hide():$(i[t]).find(".hiddenButton").show(),r.FileSystemObjectType==1?($(i[t]).find(".downloadButton").hide(),$(i[t]).find(".moveButton").hide(),$(i[t]).find(".copyButton").hide()):($(i[t]).find(".downloadButton").show(),$(i[t]).find(".moveButton").show(),$(i[t]).find(".copyButton").show())}function at(){var i=!1,r=$("#dialogUploadDocument"),t,n,e;try{t=0;n=$("#files").data("kendoUpload").getFiles();$.each(n,function(n,t){console.log(t.name);var r=tt(t.name);r==!0&&(i=!0)});n.length>0?i?alert(InvalidFolderName):(displayLoading(),$.when(f.postDataWCFAsync("GetTokenForDocument")).then(function(i){var u=i.GetTokenForDocumentResult;$.when(f.CheckFileExist(a,u)).then(function(i){var v=null,e,s,y;for(a!=null&&(v=a.replace(w,"")),e=[],s=0;s<n.length;s++){var l=!0,h=n[s],p=h;i.d.results.length>0&&(y=i.d.results.filter(function(n){return n.Name.toUpperCase()==h.name.toUpperCase()}),y.length>0&&(confirm("A file with name "+h.name+" already exists. Would you like to replace the existing one? ")?l=!0:(e.push(h.name),l=!1)));l&&(t=t+1,$.when(f.addDocumentToLibrary(o,p,u,v)).then(function(t){if(e.push(t),n.length==e.length){var i=$("#files").data("kendoUpload");i.clearAllFiles();alert("File uploaded successfully");r.data("kendoWindow").close();c()}}))}t==0&&hideLoading()})})):alert("Please select the file(s) to be uploaded. ")}catch(u){e={method:"UploadDocument",exceptionMessage:"message:"+u.message+" stack:"+u.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",e)).then(function(){alert(errormessage);hideLoading();r.data("kendoWindow").close()})}}function vt(){var t=$("#dialogCreateFolder"),n,r;try{if(n=document.getElementById("createfolder").value,n!="")tt(n)?alert(InvalidFolderName):(displayLoading(),$.when(f.postDataWCFAsync("GetTokenForDocument")).then(function(i){var r=i.GetTokenForDocumentResult;$.when(f.CheckFolderExist(y,r)).then(function(i){if(i.d.results.length>0){var u=i.d.results.filter(function(t){return t.Name.toUpperCase()==n.toUpperCase()});if(u.length>0){alert('A folder with the name you entered "'+n+'" already exists. Please select a different name.');hideLoading();return}}$.when(f.createFolderToLibrary(o,r,y,n)).then(function(){alert("Folder created successfully");c();hideLoading();t.data("kendoWindow").close()})})}));else{alert("Please enter the folder name to be created.");return}}catch(i){r={method:"CreateFolder",exceptionMessage:"message:"+i.message+" stack:"+i.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",r)).then(function(){alert(errormessage);hideLoading();t.data("kendoWindow").close()})}}function yt(){var t=$("#dialogUpdateFolderFile"),n,r;try{if(n=document.getElementById("renameFolder").value,n!="")tt(n)?alert(InvalidFolderName):(displayLoading(),$.when(f.postDataWCFAsync("GetTokenForDocument")).then(function(i){var r=i.GetTokenForDocumentResult;$.when(f.renameFileFolder(r,updateId,n)).then(function(i){if(i=="Success")t.data("kendoWindow").close(),c(),hideLoading();else{if(i.includes("already exist")==!0){alert('A folder with the name you entered "'+n+'" already exists. Please select a different name.');hideLoading();return}alert("Error in renaming");hideLoading();return}})}));else{alert("Please enter the name to be updated.");return}}catch(i){r={method:"UpdateFileFolderName",exceptionMessage:"message:"+i.message+" stack:"+i.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",r)).then(function(){alert(errormessage);hideLoading();t.data("kendoWindow").close()})}}function pt(){try{displayLoading();$.when(f.postDataWCFAsync("GetTokenForDocument"),f.postDataWCFAsync("GetProjectRootSiteUrl",SeletedProjectId)).then(function(n,t){var o=n.GetTokenForDocumentResult,u,i,r;JSON.parse(t.GetProjectRootSiteUrlResult).length>0&&(u=JSON.parse(t.GetProjectRootSiteUrlResult)[0],rootSiteUrl=u.rootSiteUrl,siteTemplate=u.siteTemplate);i=v;r=dt(v);isConfidentialProject==!0&&(i=i.substring("7",i.length),r=r.substring("7",r.length));$.when(f.createProjectSite(o,i,isConfidentialProject),f.getDataWCF("getProjectTeam/"+SeletedProjectId)).then(function(n,t){var i,r;n=="Success"||n=="already exist"?(i=JSON.parse(t.getProjectTeamResult),e.show=!1,alert("Project site created successfully."),SeletedProjectId=getParameterByName(window.location.search,"ProblemID"),r={ProjectID:SeletedProjectId,ProjectSiteURL:ProjectSiteUrl},$.when(f.postDataWCFAsync("insertUpdateProjectSiteURL",r)).then(function(n){try{n=="Success"&&(console.log("Project Site updated"),c(),i.length>0&&isConfidentialProject==!0&&f.getAllMembers(i))}catch(t){var r={method:"CreateProjectSite",exceptionMessage:"message:"+t.message+" stack:"+t.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",r)).then(function(){console.log("Error in database operation for project site update")})}})):(alert("Error in Project site creation."),hideLoading())})})}catch(n){var t={method:"CreateProjectSite",exceptionMessage:"message:"+n.message+" stack:"+n.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",t)).then(function(){alert(errormessage);hideLoading();windowname.data("kendoWindow").close()})}}function wt(n,t){try{displayLoading();$.when(f.postDataWCFAsync("GetTokenForDocument")).then(function(i){var r=i.GetTokenForDocumentResult;$.when(f.RemoveListItem(n,o,r,t)).then(function(n){n=="Success"?c():(alert("Error in deletion."),hideLoading())})})}catch(i){var r={method:"deleteDocument",exceptionMessage:"message:"+i.message+" stack:"+i.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",r)).then(function(){alert(errormessage);hideLoading()})}}function bt(){try{displayLoading();$.when(f.postDataWCFAsync("GetTokenForDocument")).then(function(n){var t=n.GetTokenForDocumentResult;$.when(f.MoveDocumentToLibrary(p,docLibraryName,t,it,v,d)).then(function(n){n=="Success"?$.when(f.UpdateCreatedByModifiedBy(t,p,docLibraryName)).then(function(){alert("Document moved successfully.");var n=$("#dialogMoveFile");n.data("kendoWindow").close();c()}):(alert("Error in moving document."),hideLoading())})})}catch(n){var t={method:"moveDocument",exceptionMessage:"message:"+n.message+" stack:"+n.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",t)).then(function(){alert(errormessage);hideLoading()})}}function kt(){try{displayLoading();$.when(f.postDataWCFAsync("GetTokenForDocument")).then(function(n){var t=n.GetTokenForDocumentResult;$.when(f.CopyDocumentToLibrary(nt,docLibraryName,t,rt,v,g)).then(function(n){if(n=="Success"){alert("Document copied successfully.");var t=$("#dialogCopyFile");t.data("kendoWindow").close();c()}else alert("Error in document deletion."),hideLoading()})})}catch(n){var t={method:"copyDocument",exceptionMessage:"message:"+n.message+" stack:"+n.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",t)).then(function(){alert(errormessage);hideLoading()})}}function dt(n){for(var t=n,r=["~","#","%","&","{","}",":","<",">","|",'"'],i=0;i<r.length;i++)t=t.replace(new RegExp(r[i],"gi"),"");return t=t.replace(/\\/g,""),t=t.replace(/\*/g,""),t.replace(/\//g,"")}function tt(n){var i=["*","#","\\",":","<",">","?","/","|",'"',"%"],t;if(n.startsWith(".")||n.endsWith("."))return!0;for(t=0;t<i.length;t++)if(n.indexOf(i[t])>-1)return!0;return!1}function gt(){}var e=this;e.InitProjectDocument=gt;e.UploadDocument=at;e.moveDocument=bt;e.copyDocument=kt;e.CreateFolder=vt;e.UpdateFileFolderName=yt;e.CreateProjectSite=pt;e.show=!1;e.oldName="";var h,l,it,rt,ut=!1,a="",y="",d="",g="",p="",nt="",o=docLibraryName,s="ProjectDocumentCtrl",w="",v="";n.$on("GetProjectDocument",function(n,t){isConfidentialProject=t;v=SeletedProjectName;ProjectSiteUrl!=""&&ProjectSiteUrl!=null?c():e.show=!0})}angular.module("SPOTApp").controller("ProjectDocumentCtrl",ProjectDocumentCtrl);ProjectDocumentCtrl.$inject=["$rootScope","$filter","$scope","$http","$q","GETPostService"];