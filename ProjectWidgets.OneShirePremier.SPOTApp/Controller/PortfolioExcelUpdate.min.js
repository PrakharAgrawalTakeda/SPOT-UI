function PortfolioExcelUpdateCtrl(n,t,i,r,u,f){function ut(){var t,n,u;displayLoading();try{e.BudgetDataFor=="Forecast"&&(e.LBEPeriodValue!=""&&e.LBEPeriodValue!=null&&e.BudgetDataFor!=""&&(e.BudgetId!=""||e.ProjId!="")?(e.IsForecast=!0,e.IsHistorical=!1,t=e.LBEPeriodValue.length>1?e.LBEPeriodValue.join(","):e.LBEPeriodValue[0],n=e.forecastType.filter(function(n){return n.LookUpMemberID==capexId}),e.forecastTypeValue=n[0],v={LBEPeriod:t,ProjectID:e.ProjId,BudgetID:e.BudgetId},$.when(f.postDataWCFAsync("getProjectBulkBudgetForecastDataExcel",v)).then(function(n){var t,r,h;try{c=JSON.parse(n);t=c.filter(function(n){return n.BudgetDataTypeID==capexId});r=c.filter(function(n){return n.BudgetDataTypeID==opexId});k==!0?(k=!1,o=new kendo.data.DataSource({transport:{read:function(n){n.success(t)},submit:tt},batch:!0,schema:{model:{id:"BudgetDataID",fields:{BudgetGlobalID:{type:"string"},DateMasterID:{type:"string"},BudgetDataID:{type:"string"},BudgetDataIDY1:{type:"string"},ProjectID:{type:"string"},BudgetDataTypeID:{type:"string"},BudgetData:{type:"string"},CapitalBudgetID:{type:"string"},ProblemID:{type:"string"},ProblemTitle:{type:"string"},PeriodName:{type:"string"},HistoricalActual:{type:"number"},Apr:{type:"number"},May:{type:"number"},Jun:{type:"number"},Jul:{type:"number"},Aug:{type:"number"},Sep:{type:"number"},Oct:{type:"number"},Nov:{type:"number"},Dec:{type:"number"},Jan:{type:"number"},Feb:{type:"number"},Mar:{type:"number"},Y1_Apr:{type:"number"},Y1_May:{type:"number"},Y1_Jun:{type:"number"},Y1_Jul:{type:"number"},Y1_Aug:{type:"number"},Y1_Sep:{type:"number"},Y1_Oct:{type:"number"},Y1_Nov:{type:"number"},Y1_Dec:{type:"number"},Y1_Jan:{type:"number"},Y1_Feb:{type:"number"},Y1_Mar:{type:"number"},Y2:{type:"number"},Y3:{type:"number"},Y4:{type:"number"},Y5:{type:"number"},Y1:{type:"number"},AnnualTotal:{type:"number"},CumulativeTotal:{type:"number"}}}}}),ot(o)):e.forecastTypeValue==opexId?y(r):y(t);i.$digest();hideLoading()}catch(u){hideLoading();h={method:"GetBudgetDataForExcel",exceptionMessage:"message:"+u.message+" stack:"+u.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",h)).then(function(){alert(errormessage)});hideLoading()}})):(alert(bulkExcelDataMandatory),hideLoading()));e.BudgetDataFor=="Historical"&&(e.BudgetDataFor!=""&&(e.BudgetId!=""||e.ProjId!="")?(e.IsForecast=!1,e.IsHistorical=!0,n=e.forecastType.filter(function(n){return n.LookUpMemberID==capexId}),e.forecastTypeHistoricalValue=n[0],w={ProjectID:e.ProjId,BudgetID:e.BudgetId},$.when(f.postDataWCFAsync("getProjectBulkBudgetHistoricalDataExcel",w)).then(function(n){var t,r,u,c;try{l=JSON.parse(n);t=l.filter(function(n){return n.BudgetDataTypeID==capexId});r=l.filter(function(n){return n.BudgetDataTypeID==opexId});d==!0?(d=!1,u=e.forecastType.filter(function(n){return n.LookUpMemberID==capexId}),e.forecastTypeHistoricalValue=u[0],h=new kendo.data.DataSource({transport:{read:function(n){n.success(t)},submit:it},batch:!0,schema:{model:{id:"BudgetHistoricalActualID",fields:{BudgetDataTypeID:{type:"string"},ProjectID:{type:"string"},BudgetDataType:{type:"string"},ProblemID:{type:"string"},CapitalBudgetID:{type:"string"},ProblemTitle:{type:"string"},HistoricalActual:{type:"number"},HistoricalActualFY14:{type:"number"},HistoricalActualFY15:{type:"number"},HistoricalActualFY16:{type:"number"},HistoricalActualFY17:{type:"number"},HistoricalActualFY18:{type:"number"},HistoricalActualFY19:{type:"number"},HistoricalActualFY20:{type:"number"},HistoricalActualFY21:{type:"number"}}}}}),st(h)):e.forecastTypeHistoricalValue==opexId?p(r):p(t);i.$digest();hideLoading()}catch(o){hideLoading();c={method:"GetBudgetDataForExcel",exceptionMessage:"message:"+o.message+" stack:"+o.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",c)).then(function(){alert(errormessage)});hideLoading()}})):(alert(bulkExcelDataHistoricalMandatory),hideLoading()))}catch(r){hideLoading();u={method:"GetBudgetDataForExcel",exceptionMessage:"message:"+r.message+" stack:"+r.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",u)).then(function(){alert(errormessage)});hideLoading()}}function ft(){var n,r;displayLoading();try{n=BudgetForecast;e.LBEPeriodValue=null;e.ProjId="";e.BudgetId="";v={LBEPeriod:"",ProjectID:"",BudgetID:""};$.when(f.postDataWCFAsync("getLookupData",n),f.postDataWCFAsync("GetLBEPeriodData"),f.postDataWCFAsync("getUserPermissionById",currentUserId),f.postDataWCFAsync("getYearLabel")).then(function(n,t,r,u){var o,h,c,v;try{o=JSON.parse(r.getUserPermissionByIdResult);o!=null&&(h=o.filter(function(n){return n.Permission==updateBudgetPerm}),h.length>0&&(rt=!0));e.dsLBEPeriodData=JSON.parse(t.getLBEPeriodDataResult);e.dsLBEPeriod={placeholder:"Select LBE Period...",dataTextField:"PeriodName",dataValueField:"DateMasterID",valuePrimitive:!0,autoBind:!1,dataSource:e.dsLBEPeriodData,filter:"contains"};c=JSON.parse(n.getLookupDataResult);e.forecastType=c.filter(function(n){return n.LookUpName==BudgetForecast});a=JSON.parse(u.getYearLabelResult);et();i.$digest();hideLoading()}catch(l){hideLoading();v={method:"prepareDataForPortfolioForecastExcelUpdate",exceptionMessage:"message:"+l.message+" stack:"+l.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",v)).then(function(){alert(errormessage)});hideLoading()}})}catch(t){hideLoading();r={method:"prepareDataForPortfolioForecastExcelUpdate",exceptionMessage:"message:"+t.message+" stack:"+t.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",r)).then(function(){alert(errormessage)});hideLoading()}}function et(){b=[{field:"BudgetGlobalID",title:"Budget Global ID"},{field:"DateMasterID",title:"Date Master ID"},{field:"BudgetDataID",title:"Budget Data ID"},{field:"BudgetDataIDY1",title:"Budget Data ID Y1"},{field:"ProjectID",title:"Project ID"},{field:"BudgetDataTypeID",title:"Budget Data Type ID"},{field:"BudgetData",title:"Budget Data"},{field:"CapitalBudgetID",title:"Capital Budget ID"},{field:"ProblemID",title:"Problem ID"},{field:"ProblemTitle",title:"Project Name"},{field:"PeriodName",title:"Period Name"},{field:"HistoricalActual",title:"Historical Actual"},{field:"Apr",title:"Apr"},{field:"May",title:"May"},{field:"Jun",title:"Jun"},{field:"Jul",title:"Jul"},{field:"Aug",title:"Aug"},{field:"Sep",title:"Sep"},{field:"Oct",title:"Oct"},{field:"Nov",title:"Nov"},{field:"Dec",title:"Dec"},{field:"Jan",title:"Jan"},{field:"Feb",title:"Feb"},{field:"Mar",title:"Mar"},{field:"Y1_Apr",title:"AprY1"},{field:"Y1_May",title:"MayY1"},{field:"Y1_Jun",title:"JunY1"},{field:"Y1_Jul",title:"JulY1"},{field:"Y1_Aug",title:"AugY1"},{field:"Y1_Sep",title:"SepY1"},{field:"Y1_Oct",title:"OctY1"},{field:"Y1_Nov",title:"NovY1"},{field:"Y1_Dec",title:"DecY1"},{field:"Y1_Jan",title:"JanY1"},{field:"Y1_Feb",title:"FebY1"},{field:"Y1_Mar",title:"MarY1"},{field:"Y2",title:a[2].TblLabel},{field:"Y3",title:a[3].TblLabel},{field:"Y4",title:a[4].TblLabel},{field:"Y5",title:a[5].TblLabel},{field:"Y1",title:a[1].TblLabel},{field:"AnnualTotal",title:"Annual Total"},{field:"CumulativeTotal",title:"Cumulative Total"},]}function ot(n){var o=$("#GridPortfolioForecastDataExcel").kendoSpreadsheet({toolbar:!1,sheetsbar:!1,sheets:[{name:"Products",dataSource:n,columns:[{width:250},{width:250},{width:250},{width:250},{width:250},{width:250},{width:100},{width:100},{width:100},{width:300},{width:100},{width:100},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75},{width:75}]}],select:function(n){!0&&n.range.validation({dataType:"number",comparerType:"between",from:-9999,to:1e6,allowNulls:!0,type:"reject",messageTemplate:"The value should be a number."})}}).data("kendoSpreadsheet"),t=o.activeSheet(),r,i,u,f,e;t.setDataSource(n,b);r=n.data().length==undefined||n.data().length==0?0:n.data().length+1;r>0&&(i=r.toString(),t.range("AP2:AP"+i).formula("SUM(M2:X2)"),t.range("AO2:AO"+i).formula("SUM(Y2:AJ2)"),t.range("AQ2:AQ"+i).formula("SUM(L2:AN2)"),u=t.range(0,0,r,12),u.color("Black"),u.enable(!1),f=t.range("AO1:AQ"+i),f.enable(!1),f.color("Black"));e=t.range("A0: AQ0");e.enable(!1);e.color("Black");t.hideColumn(0);t.hideColumn(1);t.hideColumn(2);t.hideColumn(3);t.hideColumn(4);t.hideColumn(5)}function y(n){var s,t,r,i,u,f,e;o=new kendo.data.DataSource({transport:{read:function(t){t.success(n)},submit:tt},batch:!0,schema:{model:{id:"BudgetDataID",fields:{BudgetGlobalID:{type:"string"},DateMasterID:{type:"string"},BudgetDataID:{type:"string"},BudgetDataIDY1:{type:"string"},ProjectID:{type:"string"},BudgetDataTypeID:{type:"string"},BudgetData:{type:"string"},CapitalBudgetID:{type:"string"},ProblemID:{type:"string"},ProblemTitle:{type:"string"},PeriodName:{type:"string"},HistoricalActual:{type:"number"},Apr:{type:"number"},May:{type:"number"},Jun:{type:"number"},Jul:{type:"number"},Aug:{type:"number"},Sep:{type:"number"},Oct:{type:"number"},Nov:{type:"number"},Dec:{type:"number"},Jan:{type:"number"},Feb:{type:"number"},Mar:{type:"number"},Y1_Apr:{type:"number"},Y1_May:{type:"number"},Y1_Jun:{type:"number"},Y1_Jul:{type:"number"},Y1_Aug:{type:"number"},Y1_Sep:{type:"number"},Y1_Oct:{type:"number"},Y1_Nov:{type:"number"},Y1_Dec:{type:"number"},Y1_Jan:{type:"number"},Y1_Feb:{type:"number"},Y1_Mar:{type:"number"},Y2:{type:"number"},Y3:{type:"number"},Y4:{type:"number"},Y5:{type:"number"},Y1:{type:"number"},AnnualTotal:{type:"number"},CumulativeTotal:{type:"number"}}}}});s=$("#GridPortfolioForecastDataExcel").data("kendoSpreadsheet");t=s.activeSheet();t.setDataSource(o,b);r=o.data().length==undefined||o.data().length==0?0:o.data().length+1;r>0&&(i=r.toString(),t.range("AP2:AP"+i).formula("SUM(M2:X2)"),t.range("AO2:AO"+i).formula("SUM(Y2:AJ2)"),t.range("AQ2:AQ"+i).formula("SUM(L2:AN2)"),u=t.range(0,0,r,12),u.color("Black"),u.enable(!1),f=t.range("AO1:AQ"+i),f.enable(!1),f.color("Black"));e=t.range("A0: AQ0");e.enable(!1);e.color("Black");t.hideColumn(0);t.hideColumn(1);t.hideColumn(2);t.hideColumn(3);t.hideColumn(4);t.hideColumn(5)}function st(n){var e=$("#GridPortfolioHistoricalDataExcel").kendoSpreadsheet({toolbar:!1,sheetsbar:!1,sheets:[{name:"Historical",dataSource:n}],select:function(n){!0&&n.range.validation({dataType:"number",comparerType:"between",from:0,to:1e6,allowNulls:!0,type:"reject",messageTemplate:"The value should be a number."})}}).data("kendoSpreadsheet"),r=n.data().length==undefined?0:n.data().length+1,t=e.activeSheet(),u=t.range(0,0,r,8),f,i;u.enable(!1);u.color("Black");f=r.toString();t.range("H2:H"+f).formula("SUM(I2:P2)");i=t.range("A0: P0");i.enable(!1);i.color("Black");t.hideColumn(0);t.hideColumn(1);t.hideColumn(2)}function p(n){var f,t,i,r,e,u;h=new kendo.data.DataSource({transport:{read:function(t){t.success(n)},submit:it},batch:!0,schema:{model:{id:"BudgetHistoricalActualID",fields:{BudgetDataTypeID:{type:"string"},ProjectID:{type:"string"},BudgetDataType:{type:"string"},ProblemID:{type:"string"},CapitalBudgetID:{type:"string"},ProblemTitle:{type:"string"},HistoricalActual:{type:"number"},HistoricalActualFY14:{type:"number"},HistoricalActualFY15:{type:"number"},HistoricalActualFY16:{type:"number"},HistoricalActualFY17:{type:"number"},HistoricalActualFY18:{type:"number"},HistoricalActualFY19:{type:"number"},HistoricalActualFY20:{type:"number"},HistoricalActualFY21:{type:"number"}}}}});f=$("#GridPortfolioHistoricalDataExcel").data("kendoSpreadsheet");t=f.activeSheet();t.setDataSource(h);i=h.data().length==undefined?0:h.data().length+1;r=t.range(0,0,i,8);r.color("Black");r.enable(!1);e=i.toString();t.range("H2:H"+e).formula("SUM(I2:P2)");u=t.range("A0: P0");u.enable(!1);u.color("Black");t.hideColumn(0);t.hideColumn(1);t.hideColumn(2)}function g(){var n,t;trackEvent("Portfolio center budget/spend tile forecast bulk edit Excel tab - change forecast type");e.forecastTypeValue.LookUpMemberID==capexId?(n=c.filter(function(n){return n.BudgetDataTypeID==capexId}),y(n)):(t=c.filter(function(n){return n.BudgetDataTypeID==opexId}),y(t));hideLoading()}function nt(){var n,t;trackEvent("Portfolio center budget/spend tile forecast bulk edit Excel tab - change forecast type");e.forecastTypeHistoricalValue.LookUpMemberID==capexId?(n=l.filter(function(n){return n.BudgetDataTypeID==capexId}),p(n)):(t=l.filter(function(n){return n.BudgetDataTypeID==opexId}),p(t));hideLoading()}function ht(){o.sync()}function ct(){h.sync()}function tt(t){displayLoading();var i=t.data.updated.filter(function(n){return n.BudgetDataTypeID==e.forecastTypeValue.LookUpMemberID}),r={ForecastExcelGridData:JSON.stringify(i),userId:currentUserId,HistoricalExcelGridData:""};$.when(f.postDataWCFAsync("insertUpdateProjectBulkBudgetForecastDataExcel",r)).then(function(){alert(saveMessage);$.when(f.postDataWCFAsync("getProjectBulkBudgetForecastDataExcel",v)).then(function(t){try{c=JSON.parse(t);n.$emit("applyFilterFunc");g()}catch(i){hideLoading();var r={method:"onSubmit",exceptionMessage:"message:"+i.message+" stack:"+i.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",r)).then(function(){alert(errormessage)});hideLoading()}})})}function it(t){displayLoading();var i=t.data.updated.filter(function(n){return n.BudgetDataTypeID==e.forecastTypeHistoricalValue.LookUpMemberID}),r={ForecastExcelGridData:"",userId:currentUserId,HistoricalExcelGridData:JSON.stringify(i)};$.when(f.postDataWCFAsync("insertUpdateProjectBulkBudgetForecastDataExcel",r)).then(function(){alert(saveMessage);$.when(f.postDataWCFAsync("getProjectBulkBudgetHistoricalDataExcel",w)).then(function(t){try{l=JSON.parse(t);n.$emit("applyFilterFunc");nt()}catch(i){hideLoading();var r={method:"onSubmitHistorical",exceptionMessage:"message:"+i.message+" stack:"+i.stack,ErrorParameter:s};$.when(f.postDataWCFAsync("WriteErrorLog",r)).then(function(){alert(errormessage)});hideLoading()}})})}function lt(){}var e=this;e.showLocalCur=!0;e.ProjId="";e.BudgetId="";e.BudgetDataFor="Forecast";e.IsOpen=!1;e.IsForecast=!1;e.IsHistorical=!1;e.initPortfolioBudgetExcelUpdate=lt;e.GetBudgetDataForExcel=ut;e.forecastChangeExcel=g;e.forecastChangeHistoricalExcel=nt;e.SaveExcelDataHistorical=ct;e.SaveExcelData=ht;var s="PortfolioExcelUpdateCtrl",c=[],l=[],o=new kendo.data.DataSource,h=new kendo.data.DataSource,rt=!1,v,w,k=!0,d=!0,b=[],a=[];n.$on("portfolioForecastExcelUpdate",function(){e.IsForecast=!1;e.IsHistorical=!1;ft()})}angular.module("SPOTApp").controller("PortfolioExcelUpdateCtrl",PortfolioExcelUpdateCtrl);PortfolioExcelUpdateCtrl.$inject=["$rootScope","$filter","$scope","$http","$q","GETPostService"];