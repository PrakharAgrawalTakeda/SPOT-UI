function PortfolioForecastCtrl(n,t,i,r,u,f){function ht(){trackEvent("Portfolio center budget/spend tile forecast bulk edit tab - FxRates button");var n=$("#dialogFxRate");n.kendoWindow({content:"CurrencyFxRate.html?v="+buildNo,modal:!0});$.when(f.getCurrencyFxRate()).then(function(){n.data("kendoWindow").open()})}function b(){trackEvent("Portfolio center budget/spend tile forecast bulk edit tab - change currency");var n=e.PortfolioLocalCurrencyValue.LookUpMemberID==OKU_ID?!1:!0;e.showLocalCur=n;n==!0?($("#GridPortfolioForecastCummulative").hide(),$("#GridPortfolioForecastCummulativeLocal").show()):($("#GridPortfolioForecastCummulative").show(),$("#GridPortfolioForecastCummulativeLocal").hide())}function ut(){var n,t,i,r,u,f;trackEvent("Portfolio center budget/spend tile forecast bulk edit tab - change forecast type");o=new kendo.data.DataSource;s=new kendo.data.DataSource;h=new kendo.data.DataSource;$("#GridPortfolioForecastCummulative").show();$("#GridPortfolioForecastCummulativeLocal").show();e.forecastTypeValue.LookUpMemberID==capexId?(o=ds_PortfolioForecast_GridPortfolioForecastData(k),n=$("#GridPortfolioForecastData").data("kendoGrid"),o.read(),n.setDataSource(o),t=$("#GridPortfolioForecastCummulativeLocal").data("kendoGrid"),h=ds_PortfolioForecast_GridPortfolioForecastCummulativeLocal(v),h.read(),t.setDataSource(h),i=$("#GridPortfolioForecastCummulative").data("kendoGrid"),s=ds_PortfolioForecast_GridPortfolioForecastCummulative(v),s.read(),i.setDataSource(s)):(o=ds_PortfolioForecast_GridPortfolioForecastData(d),r=$("#GridPortfolioForecastData").data("kendoGrid"),o.read(),r.setDataSource(o),u=$("#GridPortfolioForecastCummulativeLocal").data("kendoGrid"),h=ds_PortfolioForecast_GridPortfolioForecastCummulativeLocal(y),h.read(),u.setDataSource(h),f=$("#GridPortfolioForecastCummulative").data("kendoGrid"),s=ds_PortfolioForecast_GridPortfolioForecastCummulative(y),s.read(),f.setDataSource(s));b();hideLoading()}function ct(){var t,i;trackEvent("Portfolio center budget/spend tile forecast bulk edit tab - submit forecast changes button");displayLoading();$("#GridPortfolioForecastData").data("kendoGrid")!=undefined&&(t=$("#GridPortfolioForecastData").data("kendoGrid").dataSource.data().filter(function(n){return n.dirty}).map(function(n){return n}));i={objCapexGridData:JSON.stringify(t),strSubmittedByID:currentUserId};t.length>0?$.when(f.postDataWCFAsync("insertUpdateProtfolioBudget",i)).then(function(t){t=="Success"?(n.$emit("applyFilterFunc"),console.log("save"),ft()):(hideLoading(),console.log("error"))}):hideLoading()}function ft(){var n,r;displayLoading();try{n=BudgetForecast+","+PortfolioLocalCurrency;$.when(f.postDataWCFAsync("getLookupData",n),f.postDataWCFAsync("getUserPermissionById",currentUserId),f.postDataWCFAsync("getPortfolioBudgetForecastData",p),f.postDataWCFAsync("getPortfolioBudgetCummulativeData",p),f.postDataWCFAsync("getYearLabel")).then(function(n,t,r,u,c){var p,et,nt,ht,yt;try{e.ShowLocalDropDown=showLocalCurrencyDdl;p=JSON.parse(t.getUserPermissionByIdResult);p!=null&&(et=p.filter(function(n){return n.Permission==updateBudgetPerm}),et.length>0&&(g=!0));nt=JSON.parse(n.getLookupDataResult);e.forecastType=nt.filter(function(n){return n.LookUpName==BudgetForecast});e.PortfolioLocalCurrencyDS=nt.filter(function(n){return n.LookUpName==PortfolioLocalCurrency});forecastDataCummulative=JSON.parse(u);e.PreliminaryMsg=forecastDataCummulative.length>6?prelimMsg:curMsg;e.isPreliminary=forecastDataCummulative.length>6?!0:!1;st=JSON.parse(r);g&&(e.IsOpen=!0);var ot=JSON.parse(r).filter(function(n){return n.BudgetDataTypeID==capexId}),ft=JSON.parse(u).filter(function(n){return n.BudgetDataTypeID==capexId}),pt=JSON.parse(r).filter(function(n){return n.BudgetDataTypeID==opexId}),wt=JSON.parse(u).filter(function(n){return n.BudgetDataTypeID==opexId});angular.copy(ft,v);angular.copy(ot,k);angular.copy(wt,y);angular.copy(pt,d);e.ShowLocalDropDown=showLocalCurrencyDdl;e.PortfolioLocalCurrencyValue=LocalCurrencyAbbreviationPortfolio==OKU_Text?e.PortfolioLocalCurrencyDS[1]:e.PortfolioLocalCurrencyDS[0];w==!0?($("#GridPortfolioForecastCummulative").show(),$("#GridPortfolioForecastCummulativeLocal").show(),a=JSON.parse(c.getYearLabelResult),rt=col_PortfolioForecast_GridPortfolioForecastData(a),it=col_PortfolioForecast_GridPortfolioForecastCummulativeLocal(a),tt=col_PortfolioForecast_GridPortfolioForecastCummulative(a),ht=e.forecastType.filter(function(n){return n.LookUpMemberID==capexId}),e.forecastTypeValue=ht[0],o=ds_PortfolioForecast_GridPortfolioForecastData(ot),vt(),h=ds_PortfolioForecast_GridPortfolioForecastCummulativeLocal(ft),at(),s=ds_PortfolioForecast_GridPortfolioForecastCummulative(ft),lt(),b(),w=!1):ut();i.$digest();hideLoading()}catch(ct){hideLoading();yt={method:"prepareDataForPortfolioForecast",exceptionMessage:"message:"+ct.message+" stack:"+ct.stack,ErrorParameter:l};$.when(f.postDataWCFAsync("WriteErrorLog",yt)).then(function(){alert(errormessage)});hideLoading()}})}catch(t){hideLoading();r={method:"prepareDataForPortfolioForecast",exceptionMessage:"message:"+t.message+" stack:"+t.stack,ErrorParameter:l};$.when(f.postDataWCFAsync("WriteErrorLog",r)).then(function(){alert(errormessage)});hideLoading()}}function lt(){var t=0,i=null,r=tt,n;$("#GridPortfolioForecastCummulative").kendoGrid({columns:r,dataSource:s,editable:!1,navigatable:!0,dataBound:function(n){var t=$(n.sender.element).find(".k-grid-content");t.scroll(function(){var n=$("#GridPortfolioForecastData").find(".k-grid-content"),i=$("#GridPortfolioForecastCummulativeLocal").find(".k-grid-content");n.scrollLeft(t.scrollLeft());i.scrollLeft(t.scrollLeft())})}});n=$("#GridPortfolioForecastCummulative").data("kendoGrid");$(n.tbody).on("click","td",function(){var r=$(this).closest("tr"),u=$("tr",n.tbody).index(r);t=$("td",r).index(this);i=n.dataItem(r)})}function at(){var t=0,i=null,r=it,n;$("#GridPortfolioForecastCummulativeLocal").kendoGrid({columns:r,dataSource:h,editable:!1,navigatable:!0,dataBound:function(n){var t=$(n.sender.element).find(".k-grid-content");t.scroll(function(){var n=$("#GridPortfolioForecastData").find(".k-grid-content"),i=$("#GridPortfolioForecastCummulative").find(".k-grid-content");n.scrollLeft(t.scrollLeft());i.scrollLeft(t.scrollLeft())})}});n=$("#GridPortfolioForecastCummulativeLocal").data("kendoGrid");$(n.tbody).on("click","td",function(){var r=$(this).closest("tr"),u=$("tr",n.tbody).index(r);t=$("td",r).index(this);i=n.dataItem(r)})}function vt(){var t=0,i=0,r=null,n;$("#GridPortfolioForecastData").kendoGrid({columns:rt,dataSource:o,sortable:!0,allowCopy:!0,editable:!0,navigatable:!0,pageable:!0,edit:function(i){var o,u,h;try{o=5;c=[];e.IsOpen?(u=n.columns[i.container.index()+o].field,nt.indexOf(u)!=-1&&nt.indexOf(u)<i.model.ActualMonths?this.closeCell():($("[name='"+u+"']",i.container).blur(function(){var t=n.columns[i.container.index()+o].field;et("GridPortfolioForecastData",i.model);c.length==0&&c.push(t)}),$(i.container).keydown(function(n){if(n.keyCode==9){var u=$("#GridPortfolioForecastData").data("kendoGrid"),i=$(this).closest("tr"),f=$("tr",u.tbody).index(i);t=Number($("td",i).index(this))+1;r=u.dataItem(i)}}))):this.closeCell()}catch(s){h={method:"portfolioProjectForecastGrid(edit)",exceptionMessage:"message:"+s.message+" stack:"+s.stack,ErrorParameter:l};$.when(f.postDataWCFAsync("WriteErrorLog",h)).then(function(){alert(errormessage)})}},dataBound:function(n){for(var t,i,f=this._data.map(function(n){return n}),r=0;r<f.length;r++){var o=f[r],c=o.ActualMonths,s=3,h=$("#GridPortfolioForecastData").find("[data-uid='"+o.uid+"']");for(t=0;t<c;t++)i=$("td.enableActuals:nth-child("+(s+t)+")",h),i.addClass("budgetActuals");e.isPreliminary==!0&&(i=$("td.enableActuals:nth-child("+(s+t)+")",h),i.addClass("PrelimItalic"))}var u=$(n.sender.element).find(".k-grid-content"),l=$("#GridPortfolioForecastCummulative").find(".k-grid-content"),a=$("#GridPortfolioForecastCummulativeLocal").find(".k-grid-content");u.scroll(function(){var n=$("#GridPortfolioForecastCummulative").find(".k-grid-content"),t=$("#GridPortfolioForecastCummulativeLocal").find(".k-grid-content");n.scrollLeft(u.scrollLeft());t.scrollLeft(u.scrollLeft())})}});n=$("#GridPortfolioForecastData").data("kendoGrid");$(n.tbody).on("click","td",function(){var u=$(this).closest("tr");i=$("tr",n.tbody).index(u);t=$("td",u).index(this);r=n.dataItem(u)});n.element.on("keydown",function(n){var r,o;try{n.keyCode===86&&n.ctrlKey===!0&&e.IsOpen&&(r=$("#forcast"),r.val(""),r.focus(),setTimeout(function(){for(var v,y,o,u,h,n,w=$.trim(r.val()),l=$("#GridPortfolioForecastData").data("kendoGrid"),p=w.split("\n"),e=[],a=0;a<p.length;a++){for(v=[],y=p[a].split("\t"),o=0;o<y.length;o++)v.push(y[o]);e.push(v)}c=[];var b=$("#GridPortfolioForecastData").data("kendoGrid").columns,f=l.dataItems(),s=0;for(u=i;u<f.length;u++){for(h=t;h<b.length&&e[s].length>0;h++)n=$(l.thead.find("th")[h]).attr("data-field"),c.push(n),n!="Y1"&&n!="Active"&&n!="Historical"&&n!="AnnualTotal"&&n!="CumulativeTotal"&&(f[u].ActualMonths!=null?f[u].ActualMonths.indexOf(n)==-1&&f[u].set(n,e[s].shift()):f[u].set(n,e[s].shift()));s++;et("GridPortfolioForecastData",f[u]);c=[]}l.refresh();r.val("")},1))}catch(u){o={method:"portfolioProjectForecastGrid(keydown)",exceptionMessage:"message:"+u.message+" stack:"+u.stack,ErrorParameter:l};$.when(f.postDataWCFAsync("WriteErrorLog",o)).then(function(){alert(errormessage)})}})}function et(n,t){var i=0,r=0,u=0,f=t,n,e;t.Jan!=null&&(r+=t.Jan,i+=t.Jan);t.Feb!=null&&(r+=t.Feb,i+=t.Feb);t.Mar!=null&&(r+=t.Mar,i+=t.Mar);t.Apr!=null&&(r+=t.Apr,i+=t.Apr);t.May!=null&&(r+=t.May,i+=t.May);t.Jun!=null&&(r+=t.Jun,i+=t.Jun);t.Jul!=null&&(r+=t.Jul,i+=t.Jul);t.Aug!=null&&(r+=t.Aug,i+=t.Aug);t.Sep!=null&&(r+=t.Sep,i+=t.Sep);t.Oct!=null&&(r+=t.Oct,i+=t.Oct);t.Nov!=null&&(r+=t.Nov,i+=t.Nov);t.Dec!=null&&(r+=t.Dec,i+=t.Dec);t.JanY1!=null&&(u+=t.JanY1,i+=t.JanY1);t.FebY1!=null&&(u+=t.FebY1,i+=t.FebY1);t.MarY1!=null&&(u+=t.MarY1,i+=t.MarY1);t.AprY1!=null&&(u+=t.AprY1,i+=t.AprY1);t.MayY1!=null&&(u+=t.MayY1,i+=t.MayY1);t.JunY1!=null&&(u+=t.JunY1,i+=t.JunY1);t.JulY1!=null&&(u+=t.JulY1,i+=t.JulY1);t.AugY1!=null&&(u+=t.AugY1,i+=t.AugY1);t.SepY1!=null&&(u+=t.SepY1,i+=t.SepY1);t.OctY1!=null&&(u+=t.OctY1,i+=t.OctY1);t.NovY1!=null&&(u+=t.NovY1,i+=t.NovY1);t.DecY1!=null&&(u+=t.DecY1,i+=t.DecY1);t.Y2!=null&&(i+=t.Y2);t.Y3!=null&&(i+=t.Y3);t.Y4!=null&&(i+=t.Y4);t.Y5!=null&&(i+=t.Y5);t.Historical!=null&&(i+=t.Historical);f.CumulativeTotal=i;f.AnnualTotalY1=u;f.AnnualTotal=r;n=$("#"+n).getKendoGrid();e=n.tbody.find("tr[data-uid='"+f.uid+"']");e.find("td:eq(14)").text(kendo.format("{0:#,#}",r));e.find("td:eq(27)").text(kendo.format("{0:#,#}",u));e.find("td:eq(32)").text(kendo.format("{0:#,#}",i))}function ot(){}var e=this,p,w;e.IsOpen=!1;e.isPreliminary=!1;e.initPortfolioForecast=ot;e.SaveForecastData=ct;e.forecastChange=ut;e.showLocalCur=!0;e.GetFxRates=ht;var l="PortfolioForecastCtrl",st=[],o=new kendo.data.DataSource,s=new kendo.data.DataSource,h=new kendo.data.DataSource,c=[],v=[],k=[],y=[],d=[],g=!1,a=[];e.initPortfolioForecast=ot;e.UpdateForecastCummulativeGrid=b;w=!0;const nt=["Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar"];var tt=[],it=[],rt=[];n.$on("portfolioBudgetForecast",function(n,t){p=JSON.parse(t);ft()})}angular.module("SPOTApp").controller("PortfolioForecastCtrl",PortfolioForecastCtrl);PortfolioForecastCtrl.$inject=["$rootScope","$filter","$scope","$http","$q","GETPostService"];