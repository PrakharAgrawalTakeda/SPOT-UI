function MyPreferenceCtrl(n,t,i,r,u,f){function p(){$("#dialogMilestoneDetails").data("kendoWindow").close()}function w(){e.SelectedMilestoneSetObj={MilestoneTemplateID:kendo.guid(),PortfolioID:""};e.selectedPortfolioOwner=null;l("New")}function b(n){var t=$("#"+n).data("kendoGrid"),i;newItemSortOrder=(t.dataItems().length+1)*100;i={SortOrder:newItemSortOrder,FuntionalOwnerID:"",Milestone:"",MilestoneTemplateID:e.SelectedMilestoneSetObj.MilestoneTemplateID};t.dataSource.add(i)}function k(){window.location.href=portfolioCenterpath}function d(){var n,o;if(e.selectedPortfolioOwner!=undefined&&e.selectedPortfolioOwner!=null&&e.selectedPortfolioOwner.PortfolioOwnerID!=""){if($("#MilestoneSetDetailGrid").data("kendoGrid")!=undefined){h=$("#MilestoneSetDetailGrid").data("kendoGrid").dataItems().length;var t=$("#MilestoneSetDetailGrid").data("kendoGrid").dataSource.data().filter(function(n){return n.dirty||n.MilestoneType==1||n.MilestoneType==2}).map(function(n){return n}),i=t.filter(function(n){return n.id==""||n.id==null}).map(function(n){return n}),s=t.filter(function(n){return n.id!=""&&n.id!=null}).map(function(n){return n}),r=[],u=[];angular.forEach(i,function(n,t){var f=h-i.length+t,u={};u.MilestoneTemplateID=e.SelectedMilestoneSetObj.MilestoneTemplateID;u.MilestoneID=n.MilestoneID;u.Milestone=n.Milestone;u.FuntionalOwnerID=n.FuntionalOwnerID;u.Comment=n.Comment;u.IncludeInReport=n.IncludeInReport;u.SortOrder=n.SortOrder==""?f*100:n.SortOrder;u.MilestoneType=n.MilestoneType;r.push(u)});angular.forEach(s,function(n){var t={};t.MilestoneTemplateID=n.MilestoneTemplateID;t.MilestoneID=n.MilestoneID;t.Milestone=n.MilestoneType==1?MilestoneStartPrefix+n.Milestone:n.MilestoneType==2?MilestoneEndPrefix+n.Milestone:n.Milestone;t.FuntionalOwnerID=n.FuntionalOwnerID;t.Comment=n.Comment;t.IncludeInReport=n.IncludeInReport;t.SortOrder=n.SortOrder;t.MilestoneType=n.MilestoneType;u.push(t)})}e.insertUpdateDeleteMilestone={insert:r,update:u,"delete":e.deletedMilestoneFromSetData};n=[];n.push(e.insertUpdateDeleteMilestone);e.milestoneSetInfoData={MilestoneTemplateID:e.SelectedMilestoneSetObj.MilestoneTemplateID,PortfolioID:e.selectedPortfolioOwner.PortfolioOwnerID,MilestoneSet:e.SelectedMilestoneSetObj.MilestoneSet};o={userId:currentUserId,milestoneSetInfo:JSON.stringify(e.milestoneSetInfoData),insertUpdateDeleteMilestone:JSON.stringify(n)};f.postDataWCFAsync("insertUpdateMilestoneSet",o).then(function(n){n=="Success"&&$.when(f.postDataWCFAsync("getUserMilestoneTemplates",currentUserId)).then(function(n){var i=JSON.parse(n.getUserMilestoneTemplatesResult),t=new kendo.data.DataSource({data:i,sort:[{field:"PortfolioOwner",dir:"asc"},{field:"MilestoneSet",dir:"asc"}]}),r=$("#gridMilestoneSets").data("kendoGrid");t.read();r.setDataSource(t);$("#dialogMilestoneDetails").data("kendoWindow").close()})})}else alert("Please select Portfolio Owner!!..")}function g(){var n=funtionalGroup;$.when(f.postDataWCFAsync("getLookupData",n),f.postDataWCFAsync("getUserPreferanceByID",currentUserId),f.postDataWCFAsync("getUserPortfolioGroup",currentUserId),f.postDataWCFAsync("getUserMilestoneTemplates",currentUserId)).then(function(n,t,r,u){var l=JSON.parse(t.getUserPreferanceByIDResult),o,a,h,f,c;if(e.userInfo=l[0],o=JSON.parse(r.getUserPortfolioGroupResult),a=JSON.parse(n.getLookupDataResult),o.length>0){for(e.isPortfolioGroupOwner=!0,h=JSON.parse(u.getUserMilestoneTemplatesResult),e.dsPortfolioOwner=o,e.dsFuntionalGroup=JSON.parse(n.getLookupDataResult).filter(function(n){return n.LookUpName===funtionalGroup}),f=0;f<e.dsFuntionalGroup.length;f++)c={text:e.dsFuntionalGroup[f].LookUpMemberName,value:e.dsFuntionalGroup[f].LookUpMemberID},s.push(c);nt(h);y=0}else hideLoading();i.$digest()})}function nt(n){var t=[{field:"PortfolioOwner",title:"Portfolio Owner",headerAttributes:{"class":"wrap-header"}},{field:"MilestoneSet",title:"Milestone Set",headerAttributes:{"class":"wrap-header"}},{field:"TemplateOwnerName",title:"Template Owner",width:"10%"},{field:"CreatedDate",title:"Creation Date",headerAttributes:{"class":"wrap-header"},template:function(n){return n.CreatedDate!=null&&n.CreatedDate!=""?kendo.toString(kendo.parseDate(new Date(n.CreatedDate),"yyyy-MM-dd"),"dd-MMM-yy"):""}},{command:[{name:" ",iconClass:"k-icon k-i-edit",width:"10%",click:function(n){var u,r,t,h;try{n.target.childNodes[0].className.indexOf("k-i-edit")>-1?(n.preventDefault(),displayLoading(),r=$(n.target).closest("tr"),t=this.dataItem(r),e.SelectedMilestoneSetObj=t,l("Update")):n.target.childNodes[0].className.indexOf("k-i-close")>-1&&(confirm(gridDeleteMessage)?(n.preventDefault(),displayLoading(),u=$("#gridMilestoneSets").data("kendoGrid"),r=$(n.target).closest("tr"),t=u.dataItem(r),t.MilestoneTemplateID!=undefined&&t.MilestoneTemplateID!=""&&$.when(f.postDataWCFAsync("deleteMilestoneSet",t.MilestoneTemplateID)).then(function(n){if(n.deleteMilestoneSetResult=="Success"){var t=$("#gridMilestoneSets").data("kendoGrid");t.removeRow(r);i.$digest();hideLoading()}})):n.preventDefault())}catch(s){h={method:"InitMilestoneTempleGrid",exceptionMessage:"message:"+s.message+" stack:"+s.stack,ErrorParameter:o};$.when(f.postDataWCFAsync("WriteErrorLog",h)).then(function(){alert(errormessage)})}}},{name:" ",iconClass:"k-icon k-i-close",width:"10%"}]}];$("#gridMilestoneSets").kendoGrid({dataSource:{data:n,sort:[{field:"PortfolioOwner",dir:"asc"},{field:"MilestoneSet",dir:"asc"}]},height:370,sortable:!0,schema:{model:{fields:{PortfolioOwner:{type:"string"},MilestoneSet:{type:"string"},MilestoneTemplateID:{type:"string"},TemplateOwnerName:{type:"string"},CreatedDate:{type:"date"}}}},columns:t});hideLoading()}function tt(){v=!1}function l(n){var t,i,u;try{displayLoading();v&&tt();e.SelectedMilestoneSetObj!=null&&n=="New"?e.SelectedMilestoneSetObj.PortfolioID!=""&&(t=e.dsPortfolioOwner.filter(function(n){return n.PortfolioOwnerID==e.SelectedMilestoneSetObj.PortfolioID}),e.selectedPortfolioOwner=t[0]):e.SelectedMilestoneSetObj.PortfolioID!=""&&(t=e.dsPortfolioOwner.filter(function(n){return n.PortfolioOwnerID==e.SelectedMilestoneSetObj.PortfolioID}),e.selectedPortfolioOwner=t[0]);it();i=$("#dialogMilestoneDetails");i.data("kendoWindow").open()}catch(r){u={method:"MilestoneSetEdit",exceptionMessage:"message:"+r.message+" stack:"+r.stack,ErrorParameter:o};$.when(f.postDataWCFAsync("WriteErrorLog",u)).then(function(){alert(errormessage)});hideLoading()}}function it(){$.when(f.postDataWCFAsync("getMilestoneSetDetails",e.SelectedMilestoneSetObj.MilestoneTemplateID)).then(function(n){function y(n,t){$('<input name="'+t.field+'"/>').appendTo(n).kendoComboBox({autoBind:!1,dataTextField:"text",dataValueField:"value",filter:"contains",valuePrimitive:!0,dataSource:s})}var t,r,u,v;milestoneSetDetailsData=JSON.parse(n.getMilestoneSetDetailsResult);h=milestoneSetDetailsData.length;try{t=new kendo.data.DataSource({transport:{read:function(n){n.success(milestoneSetDetailsData)}},sort:[{field:"SortOrder",dir:"asc"}],batch:!0,schema:{model:{id:"MilestoneID",fields:{SortOrder:{editable:!1},Milestone:{type:"string"},FunctionalGroupName:{type:"string"},FuntionalOwnerID:{type:"string"},IncludeInReport:{type:"boolean"},Comment:{type:"string"}}}}});c==1?(r=[{field:"SortOrder",title:" ",width:60,template:function(){return'<div class="row" style="margin: 0px !important;padding:0px""><div class="col-xs-6" style="padding:0px"><a class="k-button k-button-Custom btnUp filter_btn"><span class="fa fa-arrow-up"><\/span><\/a><\/div><div class="col-xs-6" style="padding:0px"><a class="k-button k-button-Custom btnDown filter_btn"><span class="fa fa-arrow-down"><\/span><\/a><\/div><\/div>'},editable:!1},{field:"Milestone",title:"Milestone",template:function(n){return n.MilestoneType==1?(n.Milestone=n.Milestone.replace(MilestoneStartPrefix,""),n.Milestone==MilestoneExecutionInsert||n.Milestone.trim()==""?"<span class='RedQuality'><b>"+MilestoneStartPrefix+"<\/b>"+MilestoneExecutionInsert+"<\/span>":"<b>"+MilestoneStartPrefix+"<\/b>"+n.Milestone):n.MilestoneType==2?(n.Milestone=n.Milestone.replace(MilestoneEndPrefix,""),n.Milestone==MilestoneExecutionInsert||n.Milestone.trim()==""?"<span class='RedQuality'><b>"+MilestoneEndPrefix+"<\/b>"+MilestoneExecutionInsert+"<\/span>":"<b>"+MilestoneEndPrefix+"<\/b>"+n.Milestone):n.Milestone}},{field:"FuntionalOwnerID",title:"Functional Owner",values:s,editor:y},{field:"Comment",title:"Comment"},{field:"IncludeInReport",title:"Include in Dashboard",headerAttributes:{"class":"wrap-header"},template:function(n){return n.IncludeInReport==!0?a(n,"IncludeInReport")+'<input type="checkbox" checked class="milestoneSetChk" />':a(n,"IncludeInReport")+'<input type="checkbox" class="milestoneSetChk" />'}},{command:[{name:" ",iconClass:"k-icon k-i-close",width:"10%",visible:function(n){return n.MilestoneType==1?!1:n.MilestoneType==2?!1:!0},click:function(n){var r,u,t;confirm(gridDeleteMessage)?(n.preventDefault(),r=$("#MilestoneSetDetailGrid").data("kendoGrid"),u=$(n.target).closest("tr"),t=r.dataItem(u),t!=undefined&&t.MilestoneID!=undefined&&t.MilestoneID!=""&&e.deletedMilestoneFromSetData.push({MilestoneID:t.MilestoneID}),r.removeRow(u),i.$digest()):n.preventDefault()}}]}],$("#MilestoneSetDetailGrid").kendoGrid({dataSource:t,allowCopy:!0,columns:r,navigatable:!0,editable:{createAt:"bottom"},dataBound:function(){var i,t;$(".milestoneSetChk").on("click",function(t){dataItem=n.dataItem($(t.target).closest("tr"));dataItem.set("IncludeInReport",this.checked)});var n=$("#MilestoneSetDetailGrid").data("kendoGrid"),r=n.dataItems().length,u=$("tr",n.tbody)[0],t=$(u).find(".btnUp");t.hide();i=$("tr",n.tbody)[r-1];t=$(i).find(".btnDown");t.hide();$(".btnUp").on("click",function(t){var r=$(this).closest("tr"),o=r.attr("data-uid"),s=r.index(),u=n.dataItem(r),i,h,f,e;$("#MilestoneSetDetailGrid").data("kendoGrid").dataSource.sort({});i=s-1;h=$(".k-grid-content");i<=0&&(i=0);n.dataSource.remove(u);n.dataSource.insert(i,u);n.select("[data-uid="+o+"]");f=t.target.closest("td");$(f).prepend("<span class='k-dirty'><\/span>");u.dirty=!0;e=n.dataItems();angular.forEach(e,function(n,t){n.SortOrder!=(t+1)*100&&(n.SortOrder=(t+1)*100,n.dirty=!0)})});$(".btnDown").on("click",function(t){var i=$(this).closest("tr"),o=i.attr("data-uid"),s=i.index(),r=n.dataItem(i),u=s+1,f,e;u<n.dataSource.view().length&&(n.dataSource.remove(r),n.dataSource.insert(u,r),n.select("[data-uid="+o+"]"));$("#MilestoneSetDetailGrid").data("kendoGrid").dataSource.sort({});f=t.target.closest("td");$(f).prepend("<span class='k-dirty'><\/span>");e=n.dataItems();angular.forEach(e,function(n,t){n.SortOrder!=(t+1)*100&&(n.SortOrder=(t+1)*100,n.dirty=!0)})})}}),c=0):(u=$("#MilestoneSetDetailGrid").data("kendoGrid"),t.read(),u.setDataSource(t));hideLoading()}catch(l){hideLoading();v={method:"InitMilestoneDetailGrid",exceptionMessage:"message:"+l.message+" stack:"+l.stack,ErrorParameter:o};$.when(f.postDataWCFAsync("WriteErrorLog",v)).then(function(){alert(errormessage)})}})}function rt(n){confirm(includeArchiveMsg)?e.userInfo.includeArchived=!0:(e.userInfo.includeArchived=!1,n.preventDefault())}function ut(){displayLoading();var n={userADId:currentUserId,includeArchived:e.userInfo.includeArchived};f.postDataWCF("updateUserPreference",n).then(function(n){n=="Success"&&(hideLoading(),window.location.href=portfolioCenterpath)})}function ft(){displayLoading();console.log("Getting user AD Id");$.when(f.getUserAdID()).then(function(n){console.log("Got user AD Id");n!=""&&g()})}var e=this,o="MyPreference",v=!0,s=[],h=0,y,c,a;e.AddNewRow=b;e.showAlert=rt;e.cancelSubmit=k;e.userInfo=[];e.dsPortfolioOwner=[];e.deletedMilestoneFromSetData=[];e.isPortfolioGroupOwner=!1;e.initMyPreference=ft;e.saveMyPreference=ut;e.saveMilestoneSetDetails=d;e.MilestoneSetEdit=l;e.OpenMilestoneDetailsInfo=w;e.closeWindow=p;y=1;c=1;a=function(n,t){return n.dirty&&n.dirtyFields[t]?"<span class='k-dirty'><\/span>":""}}angular.module("SPOTApp").controller("MyPreferenceCtrl",MyPreferenceCtrl);MyPreferenceCtrl.$inject=["$rootScope","$filter","$scope","$http","$q","GETPostService"];